<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OKX BTCäº¤æ˜“æœºå™¨äºº - æ™ºèƒ½äº¤æ˜“ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/static/css/antd.css" />
    <link rel="stylesheet" href="/static/css/custom.css" />
    <script crossorigin src="/static/js/react.production.min.js"></script>
    <script crossorigin src="/static/js/react-dom.production.min.js"></script>
    <script src="/static/js/babel.min.js"></script>
    <script src="/static/js/moment.min.js"></script>
    <script src="/static/js/antd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1/dist/chartjs-adapter-moment.min.js"></script>
    <script type="text/babel" src="/static/js/app.js"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
    const { Layout, Card, Row, Col, Table, Button, message, Typography, Space, Tabs, Statistic, Pagination, InputNumber, Select } = antd;
        const { Text } = Typography;
        const { Option } = Select;

        function App() {
            const [data, setData] = useState({ system: {}, trades: [], performance: {}, analysis: [] });
            const [technicalData, setTechnicalData] = useState(null);
            const [analysisPage, setAnalysisPage] = useState(1);
            const [days, setDays] = useState(1); // æŠ€æœ¯å›¾çª—å£å¤©æ•°ï¼ˆé»˜è®¤1ï¼‰
            // å›žæµ‹æ•°æ®çŠ¶æ€
            const [backtest, setBacktest] = useState({ loading: false, data: null, error: null });
            const [backtestDays, setBacktestDays] = useState(2); // å›žæµ‹å¤©æ•°ï¼ˆé»˜è®¤2ï¼‰
            const [backtestStrategy, setBacktestStrategy] = useState('strategy_decision_v2'); // å›žæµ‹ç­–ç•¥ç‰ˆæœ¬
            const [analysisData, setAnalysisData] = useState({ data: [], pagination: {} });
            // ç­–ç•¥é…ç½®çŠ¶æ€
            const [liveStrategy, setLiveStrategy] = useState({ version: 'strategy_decision_v2', name: 'strategy_decision_v2' });
            const [availableStrategies, setAvailableStrategies] = useState([]);
            
            const handleLogout = () => {
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('username');
                window.location.href = '/';
            };

            // åŠ è½½ç­–ç•¥é…ç½®
            const loadStrategyConfig = async () => {
                try {
                    const response = await fetch(`/api/strategy-config?_t=${Date.now()}`);
                    const configData = await response.json();
                    
                    // è®¾ç½®å®žæ—¶ç­–ç•¥ä¿¡æ¯ï¼ˆåªæ˜¾ç¤ºç‰ˆæœ¬å·ï¼‰
                    const liveVersion = configData.live_trading?.version || 'strategy_decision_v2';
                    
                    setLiveStrategy({
                        version: liveVersion,
                        name: liveVersion  // ç›´æŽ¥æ˜¾ç¤ºç‰ˆæœ¬å·
                    });
                    
                    // åªæ˜¾ç¤ºå¯ç”¨çš„ç­–ç•¥ç‰ˆæœ¬
                    const enabled = (configData.available_versions || []).filter(v => v.enabled);
                    setAvailableStrategies(enabled);
                    
                    // è®¾ç½®å›žæµ‹é»˜è®¤ç‰ˆæœ¬
                    if (configData.backtest_default?.version) {
                        setBacktestStrategy(configData.backtest_default.version);
                    }
                } catch (error) {
                    console.error('ç­–ç•¥é…ç½®åŠ è½½å¤±è´¥:', error);
                }
            };

            // åŠ è½½AIåˆ†æžæ•°æ®ï¼ˆåˆ†é¡µï¼‰
            const loadAnalysisData = async (page = 1, pageSize = 10) => {
                try {
                    const response = await fetch(`/api/ai-analysis-history?page=${page}&page_size=${pageSize}&_t=${Date.now()}`);
                    const result = await response.json();
                    setAnalysisData(result);
                } catch (error) {
                    console.error('AIåˆ†æžæ•°æ®åŠ è½½å¤±è´¥:', error);
                    message.error('AIåˆ†æžæ•°æ®åŠ è½½å¤±è´¥');
                }
            };

            const loadData = async () => {
                try {
                    const t = Date.now();
                    const [system, trades, performance, technical] = await Promise.all([
                        fetch(`/api/system-status?_t=${t}`).then(r => r.json()),
                        fetch(`/api/trade-history?_t=${t}`).then(r => r.json()),
                        fetch(`/api/performance?_t=${t}`).then(r => r.json()),
                        fetch(`/api/technical-chart?days=${days}&_t=${t}`).then(r => r.json())
                    ]);
                    setData({ system: system || {}, trades: trades || [], performance: performance || {} });
                    setTechnicalData(technical);
                    
                    // åŒæ—¶åŠ è½½AIåˆ†æžæ•°æ®
                    await loadAnalysisData(analysisPage);
                } catch (error) {
                    console.error('æ•°æ®åŠ è½½å¤±è´¥:', error);
                    message.error('æ•°æ®åŠ è½½å¤±è´¥');
                }
            };

            const updateTechnicalChart = () => {
                if (!technicalData) return;
                const checkboxes = document.querySelectorAll('input[data-indicator]');
                const selected = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.dataset.indicator);
                window.initTechnicalChart && window.initTechnicalChart(technicalData, selected);
            };

            const runBacktest = async () => {
                try {
                    setBacktest(prev => ({ ...prev, loading: true, error: null }));
                    const res = await fetch('/api/backtest', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            days: backtestDays, 
                            interval: '15m',
                            strategy_version: backtestStrategy 
                        })
                    });
                    const result = await res.json();
                    if (!res.ok) throw new Error(result.error || 'å›žæµ‹å¤±è´¥');
                    setBacktest({ loading: false, data: result, error: null });
                    // æ¸²æŸ“å›žæµ‹æŠ€æœ¯å›¾ï¼ˆä¸ŽæŠ€æœ¯æŒ‡æ ‡åˆ†æžä¸€è‡´ï¼‰
                    setTimeout(() => {
                        const cbs = document.querySelectorAll('input[data-indicator-bt]');
                        const selected = Array.from(cbs).filter(cb => cb.checked).map(cb => cb.dataset.indicatorBt);
                        window.initTechnicalChart && window.initTechnicalChart(result.chart, selected, 'backtestTechnicalChart');
                    }, 50);
                    message.success('å›žæµ‹å®Œæˆ');
                } catch (err) {
                    console.error('å›žæµ‹å¤±è´¥:', err);
                    setBacktest({ loading: false, data: null, error: err.message || String(err) });
                    message.error('å›žæµ‹å¤±è´¥: ' + (err.message || err));
                }
            };



            window.updateTechnicalChart = updateTechnicalChart;

            // days å˜åŒ–æ—¶ç«‹å³åˆ·æ–°æŠ€æœ¯å›¾å¹¶é‡å»ºå®šæ—¶åˆ·æ–°
            useEffect(() => { loadData(); const timer = setInterval(loadData, 5000); return () => clearInterval(timer); }, [days]);
            useEffect(() => { loadAnalysisData(); }, []); // åˆå§‹åŠ è½½AIåˆ†æžæ•°æ®
            useEffect(() => { loadStrategyConfig(); }, []); // åˆå§‹åŠ è½½ç­–ç•¥é…ç½®
            useEffect(() => data.trades?.length && window.initPriceChart && setTimeout(() => window.initPriceChart(data.trades), 100), [data.trades]);
            useEffect(() => data.performance?.daily_pnl && window.initDailyPnlChart && setTimeout(() => window.initDailyPnlChart(data.performance.daily_pnl), 100), [data.performance]);
            useEffect(() => technicalData && setTimeout(() => updateTechnicalChart(), 100), [technicalData]);

            const { system, trades, performance } = data;
            const { btc_info: btc = {}, account_info: account = {}, ai_signal: aiSignal = {}, position = {} } = system;
            const tableProps = { rowKey: 'key', size: 'small', pagination: false };
            const statusCards = [
                ['â‚¿', 'BTCä»·æ ¼', btc.price ? `$${btc.price.toLocaleString()}` : '--', btc.change ? `${btc.change > 0 ? '+' : ''}${btc.change.toFixed(2)}%` : '--', '#f7931a'],
                ['ðŸ’°', 'è´¦æˆ·ä½™é¢', account.balance ? `${account.balance.toFixed(2)} USDT` : '--', 'å¯ç”¨èµ„é‡‘', '#52c41a'],
                ['ðŸ§ ', 'AIå†³ç­–', aiSignal.signal || '--', `ä¿¡å¿ƒ: ${aiSignal.confidence || '--'}`, '#722ed1'],
                ['ðŸ“ˆ', 'å½“å‰æŒä»“', position.side ? `${position.side === 'LONG' || position.side === 'long' ? 'å¤š' : 'ç©º'}ä»“ ${position.size || 0} å¼ ` : '--', position.unrealized_pnl ? `ç›ˆäº: ${position.unrealized_pnl.toFixed(4)} USDT` : '--', position.unrealized_pnl != null ? (position.unrealized_pnl >= 0 ? '#f5222d' : '#52c41a') : '#1890ff']
            ];
            const perfStats = [
                [performance.total_trades || 0, 'æ€»äº¤æ˜“æ¬¡æ•°', 'ðŸ“Š', '#1890ff'],
                [`${performance.total_trades > 0 ? ((performance.winning_trades || 0) / performance.total_trades * 100).toFixed(1) : 0}%`, 'èƒœçŽ‡', 'âœ…', '#52c41a'],
                [(performance.total_pnl || 0).toFixed(2), 'æ€»ç›ˆäº', 'ðŸ’°', performance.total_pnl >= 0 ? '#f5222d' : '#52c41a'],
                [performance.total_trades > 0 ? (performance.total_pnl / performance.total_trades).toFixed(3) : '0.000', 'å¹³å‡ç›ˆäº', 'ðŸ“ˆ', performance.total_pnl >= 0 ? '#f5222d' : '#52c41a']
            ];

            const createStatCard = (icon, title, value, subtitle, color) => 
                h(Card, { className: 'balance-card' },
                    h('div', { style: { display: 'flex', alignItems: 'center', marginBottom: 8 } },
                        h('span', { style: { fontSize: '24px', marginRight: 8, color } }, icon),
                        h(Text, { type: 'secondary' }, title)
                    ),
                    h('div', { className: 'big-number' }, value),
                    h('div', { style: { fontSize: '12px', color: subtitle.includes('ç›ˆäº:') ? color : '#666' } }, subtitle)
                );

            return h(Layout, { style: { minHeight: '100vh', background: '#f5f5f5' } },
                // é¡¶éƒ¨æ ‡é¢˜æ 
                h(Layout.Header, { style: { background: '#fff', padding: '0 50px', boxShadow: '0 2px 8px #0001' } },
                    h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', height: '64px' } },
                        h(Space, null, h('span', null, 'ðŸ¤–'), h('span', { style: { fontSize: '18px', fontWeight: 'bold', color: '#1890ff' } }, 'OKX BTCäº¤æ˜“æœºå™¨äºº')),
                        h(Space, null,
                            h('span', { className: 'status-online' }, 'è¿è¡Œä¸­'),
                            h('span', null, `æœ€åŽæ›´æ–°: ${moment().format('YYYY/M/D HH:mm:ss')}`),
                            h(Button, { type: 'primary', danger: true, onClick: handleLogout }, 'ç™»å‡º')
                        )
                    )
                ),

                h(Layout.Content, { style: { maxWidth: 1400, margin: '24px auto', padding: '0 24px', width: '100%' } },
                    // æŒ‡æ ‡å¡ç‰‡è¡Œ
                    h(Row, { gutter: [16, 16], style: { marginBottom: 16 } },
                        ...statusCards.map(([icon, title, value, subtitle, color]) => 
                            h(Col, { xs: 24, sm: 12, lg: 6 }, createStatCard(icon, title, value, subtitle, color))
                        )
                    ),

                    // æŠ€æœ¯æŒ‡æ ‡å›¾è¡¨è¡Œ
                    h(Row, { gutter: [16, 16], style: { marginBottom: 16 } },
                        // æŠ€æœ¯æŒ‡æ ‡å›¾è¡¨ï¼ˆå ç”¨å…¨å®½ï¼‰
                        h(Col, { xs: 24 },
                            h(Card, { 
                                title: h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '8px' } },
                                    h('div', { style: { display: 'flex', alignItems: 'center', gap: '12px' } },
                                        h('span', null, `æŠ€æœ¯æŒ‡æ ‡åˆ†æž${technicalData?.current?.days ? 'ï¼ˆæœ€è¿‘' + technicalData.current.days + 'å¤©ï¼‰' : ''}`),
                                        // æ˜¾ç¤ºå®žæ—¶ç­–ç•¥ç‰ˆæœ¬
                                        h('span', { 
                                            style: { 
                                                fontSize: '12px', 
                                                color: '#1890ff', 
                                                background: '#e6f7ff', 
                                                padding: '2px 8px', 
                                                borderRadius: '4px',
                                                border: '1px solid #91d5ff'
                                            } 
                                        }, `å®žæ—¶ç­–ç•¥: ${liveStrategy.name}`)
                                    ),
                                    // å¸‚åœºæƒ…ç»ªä¿¡æ¯
                                    technicalData?.sentiment ? 
                                        h('div', { style: { fontSize: '12px', display: 'flex', alignItems: 'center', gap: '8px' } },
                                            h('span', { style: { color: '#666' } }, 'å¸‚åœºæƒ…ç»ª:'),
                                            h('span', { 
                                                style: { 
                                                    color: technicalData.sentiment.trend === 'bullish' ? '#52c41a' : 
                                                           technicalData.sentiment.trend === 'bearish' ? '#f5222d' : '#faad14',
                                                    fontWeight: 'bold'
                                                }
                                            }, 
                                                `ä¹è§‚${(technicalData.sentiment.positive_ratio * 100).toFixed(1)}% æ‚²è§‚${(technicalData.sentiment.negative_ratio * 100).toFixed(1)}%`
                                            ),
                                            h('span', { 
                                                style: { 
                                                    color: technicalData.sentiment.net_sentiment >= 0 ? '#52c41a' : '#f5222d',
                                                    fontSize: '11px'
                                                }
                                            }, 
                                                `å‡€å€¼${technicalData.sentiment.net_sentiment >= 0 ? '+' : ''}${technicalData.sentiment.net_sentiment.toFixed(3)}`
                                            )
                                        ) : 
                                        h('span', { style: { fontSize: '12px', color: '#999' } }, 'æƒ…ç»ªæ•°æ®èŽ·å–ä¸­...')
                                ),
                                style: { height: 450 } },
                                // æŽ§ä»¶ + æŒ‡æ ‡é€‰æ‹©å™¨
                                h('div', { className: 'indicator-controls' },
                                    // å¤©æ•°è¾“å…¥æŽ§ä»¶ï¼ˆ1~30ï¼Œé»˜è®¤2ï¼‰
                                    h('div', { style: { display: 'inline-flex', alignItems: 'center', gap: 8, marginRight: 12 } },
                                        h('span', { style: { fontSize: '12px', color: '#666' } }, 'å¤©æ•°'),
                                        h(InputNumber, {
                                            min: 1, max: 30, size: 'small', value: days,
                                            onChange: (v) => {
                                                const nv = Number(v) || 2;
                                                if (nv < 1 || nv > 30) return;
                                                setDays(nv);
                                            },
                                            style: { width: 80 }
                                        })
                                    ),
                                    h('label', null,
                                        h('input', { 
                                            type: 'checkbox', 
                                            defaultChecked: true,
                                            onChange: (e) => window.updateTechnicalChart(),
                                            'data-indicator': 'price'
                                        }),
                                        'ä»·æ ¼æ›²çº¿'
                                    ),
                                    h('label', null,
                                        h('input', { 
                                            type: 'checkbox',
                                            onChange: (e) => window.updateTechnicalChart(),
                                            'data-indicator': 'sma5'
                                        }),
                                        'SMA5'
                                    ),
                                    h('label', null,
                                        h('input', { 
                                            type: 'checkbox',
                                            onChange: (e) => window.updateTechnicalChart(),
                                            'data-indicator': 'sma20'
                                        }),
                                        'SMA20'
                                    ),
                                    h('label', null,
                                        h('input', { 
                                            type: 'checkbox',
                                            onChange: (e) => window.updateTechnicalChart(),
                                            'data-indicator': 'sma50'
                                        }),
                                        'SMA50'
                                    ),
                                    h('label', null,
                                        h('input', { 
                                            type: 'checkbox',
                                            defaultChecked: true,
                                            onChange: (e) => window.updateTechnicalChart(),
                                            'data-indicator': 'bollinger'
                                        }),
                                        'å¸ƒæž—å¸¦é€šé“'
                                    ),
                                    h('label', null,
                                        h('input', { 
                                            type: 'checkbox',
                                            onChange: (e) => window.updateTechnicalChart(),
                                            'data-indicator': 'macd'
                                        }),
                                        'MACDçº¿'
                                    ),
                                    h('label', null,
                                        h('input', { 
                                            type: 'checkbox',
                                            defaultChecked: true,
                                            onChange: (e) => window.updateTechnicalChart(),
                                            'data-indicator': 'macd_signal'
                                        }),
                                        'MACDä¿¡å·çº¿'
                                    ),
                                    h('label', null,
                                        h('input', { 
                                            type: 'checkbox',
                                            onChange: (e) => window.updateTechnicalChart(),
                                            'data-indicator': 'rsi'
                                        }),
                                        'RSI'
                                    ),
                                    h('label', null,
                                        h('input', { 
                                            type: 'checkbox',
                                            onChange: (e) => window.updateTechnicalChart(),
                                            'data-indicator': 'scores'
                                        }),
                                        'Scoreè¯„åˆ†'
                                    ),
                                    h('label', null,
                                        h('input', { 
                                            type: 'checkbox',
                                            defaultChecked: true,
                                            onChange: (e) => window.updateTechnicalChart(),
                                            'data-indicator': 'decisions'
                                        }),
                                        'äº¤æ˜“å†³ç­–'
                                    )
                                ),
                                // å›¾è¡¨åŒºåŸŸï¼ˆè¿˜åŽŸä¸ºæ— æ¨ªå‘æ»šåŠ¨ï¼‰
                                h('div', { style: { height: '280px', padding: '10px' } },
                                    h('canvas', { id: 'technicalChart' })
                                )
                            )
                        )
                    ),

                    // å›žæµ‹è§†å›¾ï¼ˆæŠ€æœ¯æŒ‡æ ‡å›¾ç»“æž„å®Œå…¨ä¸€è‡´ï¼‰
                    h(Row, { gutter: [16, 16], style: { marginBottom: 16 } },
                        h(Col, { xs: 24 },
                            h(Card, { 
                                title: h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center' } },
                                    h('span', null, `å›žæµ‹è§†å›¾ (æœ€è¿‘${backtestDays}å¤© Â· 15åˆ†é’Ÿ)`),
                                    h(Space, { size: 'middle' },
                                        backtest.loading ? h('span', { style: { color: '#faad14' } }, 'è®¡ç®—ä¸­â€¦') : null,
                                        h(Button, { type: 'primary', onClick: runBacktest, loading: backtest.loading }, 'å¼€å§‹å¤æµ‹')
                                    )
                                ),
                                style: { minHeight: 450 }
                            },
                                // å›žæµ‹çš„æŒ‡æ ‡é€‰æ‹©å™¨ï¼ˆä¸Žä¸Šæ–¹ä¿æŒä¸€è‡´ï¼‰
                                h('div', { className: 'indicator-controls' },
                                    // å›žæµ‹å¤©æ•°è¾“å…¥æŽ§ä»¶ï¼ˆ1~30ï¼Œé»˜è®¤2ï¼‰
                                    h('div', { style: { display: 'inline-flex', alignItems: 'center', gap: 8, marginRight: 12 } },
                                        h('span', { style: { fontSize: '12px', color: '#666' } }, 'å¤©æ•°'),
                                        h(InputNumber, {
                                            min: 1, max: 30, size: 'small', value: backtestDays,
                                            onChange: (v) => {
                                                const nv = Number(v) || 2;
                                                if (nv < 1 || nv > 30) return;
                                                setBacktestDays(nv);
                                            },
        								style: { width: 80 }
                                        })
                                    ),
                                    // ç­–ç•¥ç‰ˆæœ¬é€‰æ‹©å™¨
                                    h('div', { style: { display: 'inline-flex', alignItems: 'center', gap: 8, marginRight: 12 } },
                                        h('span', { style: { fontSize: '12px', color: '#666' } }, 'ç­–ç•¥'),
                                        h(Select, {
                                            size: 'small',
                                            value: backtestStrategy,
                                            onChange: (value) => setBacktestStrategy(value),
                                            style: { width: 200 }
                                        }, 
                                            availableStrategies.map(strategy => 
                                                h(Option, { 
                                                    key: strategy.version, 
                                                    value: strategy.version
                                                }, strategy.version)
                                            )
                                        )
                                    ),
                                    h('label', null,
                                        h('input', { type: 'checkbox', defaultChecked: true, onChange: () => {
                                            if (!backtest.data) return; const cbs = document.querySelectorAll('input[data-indicator-bt]'); const sel = Array.from(cbs).filter(cb => cb.checked).map(cb => cb.dataset.indicatorBt); window.initTechnicalChart && window.initTechnicalChart(backtest.data.chart, sel, 'backtestTechnicalChart');
                                        }, 'data-indicator-bt': 'price' }), 'ä»·æ ¼æ›²çº¿'
                                    ),
                                    h('label', null,
                                        h('input', { type: 'checkbox', onChange: () => { if (!backtest.data) return; const cbs = document.querySelectorAll('input[data-indicator-bt]'); const sel = Array.from(cbs).filter(cb => cb.checked).map(cb => cb.dataset.indicatorBt); window.initTechnicalChart && window.initTechnicalChart(backtest.data.chart, sel, 'backtestTechnicalChart'); }, 'data-indicator-bt': 'sma5' }), 'SMA5'
                                    ),
                                    h('label', null,
                                        h('input', { type: 'checkbox', onChange: () => { if (!backtest.data) return; const cbs = document.querySelectorAll('input[data-indicator-bt]'); const sel = Array.from(cbs).filter(cb => cb.checked).map(cb => cb.dataset.indicatorBt); window.initTechnicalChart && window.initTechnicalChart(backtest.data.chart, sel, 'backtestTechnicalChart'); }, 'data-indicator-bt': 'sma20' }), 'SMA20'
                                    ),
                                    h('label', null,
                                        h('input', { type: 'checkbox', onChange: () => { if (!backtest.data) return; const cbs = document.querySelectorAll('input[data-indicator-bt]'); const sel = Array.from(cbs).filter(cb => cb.checked).map(cb => cb.dataset.indicatorBt); window.initTechnicalChart && window.initTechnicalChart(backtest.data.chart, sel, 'backtestTechnicalChart'); }, 'data-indicator-bt': 'sma50' }), 'SMA50'
                                    ),
                                    h('label', null,
                                        h('input', { type: 'checkbox', defaultChecked: true, onChange: () => { if (!backtest.data) return; const cbs = document.querySelectorAll('input[data-indicator-bt]'); const sel = Array.from(cbs).filter(cb => cb.checked).map(cb => cb.dataset.indicatorBt); window.initTechnicalChart && window.initTechnicalChart(backtest.data.chart, sel, 'backtestTechnicalChart'); }, 'data-indicator-bt': 'bollinger' }), 'å¸ƒæž—å¸¦é€šé“'
                                    ),
                                    h('label', null,
                                        h('input', { type: 'checkbox', onChange: () => { if (!backtest.data) return; const cbs = document.querySelectorAll('input[data-indicator-bt]'); const sel = Array.from(cbs).filter(cb => cb.checked).map(cb => cb.dataset.indicatorBt); window.initTechnicalChart && window.initTechnicalChart(backtest.data.chart, sel, 'backtestTechnicalChart'); }, 'data-indicator-bt': 'macd' }), 'MACDçº¿'
                                    ),
                                    h('label', null,
                                        h('input', { type: 'checkbox', defaultChecked: true, onChange: () => { if (!backtest.data) return; const cbs = document.querySelectorAll('input[data-indicator-bt]'); const sel = Array.from(cbs).filter(cb => cb.checked).map(cb => cb.dataset.indicatorBt); window.initTechnicalChart && window.initTechnicalChart(backtest.data.chart, sel, 'backtestTechnicalChart'); }, 'data-indicator-bt': 'macd_signal' }), 'MACDä¿¡å·çº¿'
                                    ),
                                    h('label', null,
                                        h('input', { type: 'checkbox', onChange: () => { if (!backtest.data) return; const cbs = document.querySelectorAll('input[data-indicator-bt]'); const sel = Array.from(cbs).filter(cb => cb.checked).map(cb => cb.dataset.indicatorBt); window.initTechnicalChart && window.initTechnicalChart(backtest.data.chart, sel, 'backtestTechnicalChart'); }, 'data-indicator-bt': 'rsi' }), 'RSI'
                                    ),
                                    h('label', null,
                                        h('input', { type: 'checkbox', onChange: () => { if (!backtest.data) return; const cbs = document.querySelectorAll('input[data-indicator-bt]'); const sel = Array.from(cbs).filter(cb => cb.checked).map(cb => cb.dataset.indicatorBt); window.initTechnicalChart && window.initTechnicalChart(backtest.data.chart, sel, 'backtestTechnicalChart'); }, 'data-indicator-bt': 'scores' }), 'Scoreè¯„åˆ†'
                                    ),
                                    h('label', null,
                                        h('input', { type: 'checkbox', defaultChecked: true, onChange: () => { if (!backtest.data) return; const cbs = document.querySelectorAll('input[data-indicator-bt]'); const sel = Array.from(cbs).filter(cb => cb.checked).map(cb => cb.dataset.indicatorBt); window.initTechnicalChart && window.initTechnicalChart(backtest.data.chart, sel, 'backtestTechnicalChart'); }, 'data-indicator-bt': 'decisions' }), 'äº¤æ˜“å†³ç­–'
                                    )
                                ),
                                // å›¾è¡¨åŒºåŸŸï¼ˆé«˜åº¦è°ƒæ•´ä¸ºå½“å‰çš„150%ï¼š280px -> 420pxï¼‰
                                h('div', { id: 'backtestTechnicalChart-scroll', style: { height: '420px', padding: '10px', overflowX: 'auto' } },
                                    h('div', { id: 'backtestTechnicalChart-inner', style: { minWidth: '100%', height: '100%' } },
                                        h('canvas', { id: 'backtestTechnicalChart', style: { height: '100%', width: '100%' } })
                                    )
                                ),
                                backtest.data ? h('div', { style: { padding: '8px 12px', background: '#fafafa', borderRadius: 8, marginTop: 8, fontSize: '12px', lineHeight: '20px' } },
                                    h(Space, { size: 'middle', wrap: true },
                                        h('span', null, `æ•°æ®ç‚¹: ${backtest.data.summary.data_points}`),
                                        h('span', null, `ä¿¡å·æ•°: ${backtest.data.summary.total_signals}`),
                                        h('span', null, `å·²å¹³ä»“: ${backtest.data.summary.closed_trades}`),
                                        h('span', { style: { color: backtest.data.summary.net_pnl_total >= 0 ? '#f5222d' : '#52c41a', fontWeight: 'bold' } }, `å‡€æ”¶ç›Š: ${backtest.data.summary.net_pnl_total} USDT`),
                                        h('span', { style: { color: backtest.data.summary.gross_pnl_total >= 0 ? '#f5222d' : '#52c41a' } }, `æ¯›æ”¶ç›Š: ${backtest.data.summary.gross_pnl_total} USDT`),
                                        h('span', { style: { color: '#fa8c16' } }, `æ‰‹ç»­è´¹: ${backtest.data.summary.total_fees} USDT`),
                                        h('span', null, `èƒœçŽ‡: ${backtest.data.summary.win_rate}%`),
                                        h('span', null, `å‡(æ¯›): ${backtest.data.summary.avg_pnl_gross} USDT`),
                                        h('span', null, `å‡(å‡€): ${backtest.data.summary.avg_pnl_net} USDT`)
                                    )
                                ) : null
                            )
                        )
                    ),

                    // å›¾è¡¨å’Œç»©æ•ˆè¡Œ
                    h(Row, { gutter: [16, 16], style: { marginBottom: 16 } },
                        h(Col, { xs: 24, lg: 16 },
                            h(Card, { title: 'ä»·æ ¼èµ°åŠ¿ & äº¤æ˜“ä¿¡å·', style: { height: 400 } },
                                h('div', { style: { height: '320px', padding: '10px' } },
                                    h('canvas', { id: 'priceChart' })
                                )
                            )
                        ),
                        h(Col, { xs: 24, lg: 8 },
                            h(Card, { title: 'äº¤æ˜“ç»©æ•ˆ', style: { height: 400 } },
                                // ç»Ÿè®¡æŒ‡æ ‡è¡Œ
                                h(Row, { gutter: [8, 8], style: { marginBottom: 16 } },
                                    ...perfStats.map((v, i) => 
                                        h(Col, { xs: 12, key: i },
                                            h(Card, { bordered: true, size: 'small' },
                                                h(Statistic, { 
                                                    title: v[1], 
                                                    value: v[0], 
                                                    prefix: v[2], 
                                                    suffix: v[1].includes('ç›ˆäº') ? 'USDT' : '', 
                                                    valueStyle: { color: v[3], fontSize: '18px' } 
                                                })
                                            )
                                        )
                                    )
                                ),
                                // æ¯æ—¥ç›ˆäºå›¾è¡¨
                                h('div', { style: { padding: 12, background: '#fafafa', borderRadius: 8, height: '120px' } },
                                    h(Text, { strong: true, style: { display: 'block', marginBottom: 8 } }, 'æ¯æ—¥ç›ˆäº'),
                                    h('div', { style: { height: '70px' } },
                                        h('canvas', { id: 'dailyPnlChart' })
                                    )
                                )
                            )
                        )
                    ),

                    h(Row, { gutter: [16, 16] },
                        h(Col, { xs: 24, lg: 12 },
                            h(Card, { title: 'æœ€è¿‘äº¤æ˜“è®°å½•', style: { height: 450 } },
                                h(Table, {
                                    dataSource: trades.slice(-10).reverse().map((item, i) => ({ ...item, key: item.id || i })),
                                    columns: tradeColumns, ...tableProps,
                                    locale: { emptyText: 'æš‚æ— äº¤æ˜“è®°å½•' }, scroll: { y: 300 }
                                })
                            )
                        ),
                        h(Col, { xs: 24, lg: 12 },
                            h(Card, { title: 'AIåˆ†æžè¯¦æƒ…', style: { height: 450 } },
                                h(Tabs, { 
                                    defaultActiveKey: '1', 
                                    size: 'small',
                                    items: [
                                        {
                                            key: '1',
                                            label: 'å½“å‰åˆ†æž',
                                            children: h(Space, { direction: 'vertical', style: { width: '100%' }, size: 'middle' },
                                                h('div', null,
                                                    h(Text, { strong: true }, 'å†³ç­–ç†ç”±'),
                                                    h('div', { style: { marginTop: 8, padding: 16, background: '#f5f5f5', borderRadius: 8, fontSize: '14px', lineHeight: '1.6', maxHeight: '120px', overflowY: 'auto' } },
                                                        aiSignal.reason || 'ç³»ç»Ÿæ­£åœ¨åˆ†æžå¸‚åœºæ•°æ®ï¼Œè¯·ç¨å€™...'
                                                    )
                                                ),
                                                h(Row, { gutter: 16 },
                                                    ...['æ­¢æŸä»·æ ¼', 'æ­¢ç›ˆä»·æ ¼'].map((label, i) => 
                                                        h(Col, { span: 12 },
                                                            h(Text, { strong: true }, label),
                                                            h('div', { style: { fontSize: '20px', fontWeight: 'bold', color: i ? '#52c41a' : '#f5222d', marginTop: 8 } },
                                                                (i ? aiSignal.take_profit : aiSignal.stop_loss) ? `$${(i ? aiSignal.take_profit : aiSignal.stop_loss).toLocaleString()}` : '--'
                                                            )
                                                        )
                                                    )
                                                ),
                                                h('div', null,
                                                    h(Text, { strong: true }, 'æŠ€æœ¯æŒ‡æ ‡')
                                                )
                                            )
                                        },
                                        {
                                            key: '2',
                                            label: 'åŽ†å²è®°å½•',
                                            children: h('div', { style: { height: '100%' } },
                                                h(Table, {
                                                    dataSource: analysisData.data?.map((item, i) => ({ ...item, key: item.id || i })) || [],
                                                    expandable: {
                                                        expandedRowRender: record => h('div', { style: { padding: '16px', background: '#fafafa', borderRadius: '4px', fontSize: '13px', lineHeight: '1.5' } }, record.reason || 'æš‚æ— è¯¦ç»†ä¿¡æ¯'),
                                                        rowExpandable: record => !!(record.reason)
                                                    },
                                                    columns: analysisColumns, 
                                                    rowKey: 'key', 
                                                    size: 'small', 
                                                    pagination: false,
                                                    locale: { emptyText: 'æš‚æ— åˆ†æžè®°å½•' }, 
                                                    scroll: { y: 200 }
                                                }),
                                                // åˆ†é¡µç»„ä»¶
                                                analysisData.pagination?.total_count > 0 && h('div', { style: { textAlign: 'center', marginTop: '16px', paddingTop: '8px', borderTop: '1px solid #f0f0f0' } },
                                                    h(Pagination, {
                                                        current: analysisData.pagination.page,
                                                        pageSize: analysisData.pagination.page_size,
                                                        total: analysisData.pagination.total_count,
                                                        showSizeChanger: true,
                                                        showQuickJumper: true,
                                                        showTotal: (total, range) => `ç¬¬ ${range[0]}-${range[1]} æ¡ï¼Œå…± ${total} æ¡`,
                                                        pageSizeOptions: ['5', '10', '20', '50'],
                                                        size: 'small',
                                                        onChange: (page, pageSize) => {
                                                            setAnalysisPage(page);
                                                            loadAnalysisData(page, pageSize);
                                                        },
                                                        onShowSizeChange: (current, size) => {
                                                            setAnalysisPage(1);
                                                            loadAnalysisData(1, size);
                                                        }
                                                    })
                                                )
                                            )
                                        }
                                    ]
                                })
                            )
                        )
                    )
                )
            );
        }

        ReactDOM.render(h(App), document.getElementById('root'));
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OKX BTCäº¤æ˜“æœºå™¨äºº - æ™ºèƒ½äº¤æ˜“ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/static/css/antd.css" />
    <link rel="stylesheet" href="/static/css/custom.css" />
    <script crossorigin src="/static/js/react.production.min.js"></script>
    <script crossorigin src="/static/js/react-dom.production.min.js"></script>
    <script src="/static/js/babel.min.js"></script>
    <script src="/static/js/moment.min.js"></script>
    <script src="/static/js/antd.js"></script>
    <script src="/static/js/chart.js"></script>
    <script src="/static/js/chartjs-adapter-moment.min.js"></script>
    <script type="text/babel" src="/static/js/app.js"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
    const { Layout, Card, Row, Col, Table, Button, message, Typography, Space, Tabs, Statistic, Pagination, InputNumber, Select } = antd;
        const { Text } = Typography;
        const { Option } = Select;

        function App() {
            const [data, setData] = useState({ system: {}, trades: [], performance: {}, analysis: [] });
            const [technicalData, setTechnicalData] = useState(null);
            const [analysisPage, setAnalysisPage] = useState(1);
            const [days, setDays] = useState(1); // æŠ€æœ¯å›¾çª—å£å¤©æ•°ï¼ˆé»˜è®¤1ï¼‰
            const [manualTradeContracts, setManualTradeContracts] = useState(0.01); // æ‰‹åŠ¨äº¤æ˜“å¼ æ•°ï¼ˆé»˜è®¤0.01å¼ ï¼‰
            // å›žæµ‹æ•°æ®çŠ¶æ€
            const [backtest, setBacktest] = useState({ loading: false, data: null, error: null });
            const [backtestDays, setBacktestDays] = useState(3); // å›žæµ‹å¤©æ•°ï¼ˆé»˜è®¤2ï¼‰
            const [dailyPnlPage, setDailyPnlPage] = useState(1); // å¤©æ”¶ç›Šåˆ—è¡¨é¡µç 
            // å›žæµ‹æˆªè‡³æ—¶é—´ - é»˜è®¤ä¸ºå½“å‰æ—¶é—´ï¼ˆæ ¼å¼: YYYY-MM-DDTHH:MMï¼‰
            const [backtestEndTime, setBacktestEndTime] = useState(() => window.formatDateTime());
            const [backtestStrategy, setBacktestStrategy] = useState('strategy_decision_v2'); // å›žæµ‹ç­–ç•¥ç‰ˆæœ¬
            const [analysisData, setAnalysisData] = useState({ data: [], pagination: {} });
            // ç­–ç•¥é…ç½®çŠ¶æ€
            const [liveStrategy, setLiveStrategy] = useState({ version: 'strategy_decision_v2', name: 'strategy_decision_v2' });
            const [availableStrategies, setAvailableStrategies] = useState([]);
            
            const handleLogout = () => {
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('username');
                window.location.href = '/';
            };

            // åŠ è½½ç­–ç•¥é…ç½®
            const loadStrategyConfig = async () => {
                try {
                    const response = await fetch(`/api/strategy-config?_t=${Date.now()}`);
                    const configData = await response.json();
                    
                    // è®¾ç½®å®žæ—¶ç­–ç•¥ä¿¡æ¯ï¼ˆåªæ˜¾ç¤ºç‰ˆæœ¬å·ï¼‰
                    const liveVersion = configData.live_trading?.version || 'strategy_decision_v2';
                    
                    setLiveStrategy({
                        version: liveVersion,
                        name: liveVersion  // ç›´æŽ¥æ˜¾ç¤ºç‰ˆæœ¬å·
                    });
                    
                    // åªæ˜¾ç¤ºå¯ç”¨çš„ç­–ç•¥ç‰ˆæœ¬
                    const enabled = (configData.available_versions || []).filter(v => v.enabled);
                    setAvailableStrategies(enabled);
                    
                    // è®¾ç½®å›žæµ‹é»˜è®¤ç‰ˆæœ¬
                    if (configData.backtest_default?.version) {
                        setBacktestStrategy(configData.backtest_default.version);
                    }
                } catch (error) {
                    console.error('ç­–ç•¥é…ç½®åŠ è½½å¤±è´¥:', error);
                }
            };

            // åŠ è½½AIåˆ†æžæ•°æ®ï¼ˆåˆ†é¡µï¼‰
            const loadAnalysisData = async (page = 1, pageSize = 10) => {
                try {
                    const response = await fetch(`/api/ai-analysis-history?page=${page}&page_size=${pageSize}&_t=${Date.now()}`);
                    const result = await response.json();
                    setAnalysisData(result);
                } catch (error) {
                    console.error('AIåˆ†æžæ•°æ®åŠ è½½å¤±è´¥:', error);
                    message.error('AIåˆ†æžæ•°æ®åŠ è½½å¤±è´¥');
                }
            };

            const loadData = async () => {
                try {
                    const t = Date.now();
                    const [system, trades, performance, technical] = await Promise.all([
                        fetch(`/api/system-status?_t=${t}`).then(r => r.json()),
                        fetch(`/api/trade-history?_t=${t}`).then(r => r.json()),
                        fetch(`/api/performance?_t=${t}`).then(r => r.json()),
                        fetch(`/api/technical-chart?days=${days}&_t=${t}`).then(r => r.json())
                    ]);
                    setData({ system: system || {}, trades: trades || [], performance: performance || {} });
                    setTechnicalData(technical);
                    
                    // åŒæ—¶åŠ è½½AIåˆ†æžæ•°æ®
                    await loadAnalysisData(analysisPage);
                } catch (error) {
                    console.error('æ•°æ®åŠ è½½å¤±è´¥:', error);
                    message.error('æ•°æ®åŠ è½½å¤±è´¥');
                }
            };

            const updateTechnicalChart = () => {
                if (!technicalData) return;
                const checkboxes = document.querySelectorAll('input[data-indicator]');
                const selected = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.dataset.indicator);
                window.initTechnicalChart && window.initTechnicalChart(technicalData, selected);
            };

            const runBacktest = async () => {
                try {
                    setBacktest(prev => ({ ...prev, loading: true, error: null }));
                    const res = await fetch('/api/backtest', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            days: backtestDays, 
                            interval: '15m',
                            strategy_version: backtestStrategy,
                            end_time: backtestEndTime || undefined  // æˆªè‡³æ—¶é—´ï¼ˆç©ºåˆ™ä½¿ç”¨å½“å‰æ—¶é—´ï¼‰
                        })
                    });
                    const result = await res.json();
                    if (!res.ok) throw new Error(result.error || 'å›žæµ‹å¤±è´¥');
                    setBacktest({ loading: false, data: result, error: null });
                    // æ¸²æŸ“å›žæµ‹æŠ€æœ¯å›¾ï¼ˆä¸ŽæŠ€æœ¯æŒ‡æ ‡åˆ†æžä¸€è‡´ï¼‰
                    setTimeout(() => {
                        const cbs = document.querySelectorAll('input[data-indicator-bt]');
                        const selected = Array.from(cbs).filter(cb => cb.checked).map(cb => cb.dataset.indicatorBt);
                        window.initTechnicalChart && window.initTechnicalChart(result.chart, selected, 'backtestTechnicalChart');
                    }, 50);
                    message.success('å›žæµ‹å®Œæˆ');
                } catch (err) {
                    console.error('å›žæµ‹å¤±è´¥:', err);
                    setBacktest({ loading: false, data: null, error: err.message || String(err) });
                    message.error('å›žæµ‹å¤±è´¥: ' + (err.message || err));
                }
            };

            // è®¡ç®—å¤©æ”¶ç›Šæ•°æ®
            const calculateDailyPnl = (trades) => {
                if (!trades || trades.length === 0) return [];
                
                const dailyMap = {};
                trades.forEach(trade => {
                    if (trade.pnl !== null && trade.pnl !== undefined) {
                        const date = trade.timestamp.split(' ')[0]; // æå–æ—¥æœŸéƒ¨åˆ† YYYY-MM-DD
                        if (!dailyMap[date]) {
                            dailyMap[date] = 0;
                        }
                        dailyMap[date] += trade.pnl;
                    }
                });
                
                // è½¬æ¢ä¸ºæ•°ç»„å¹¶æŽ’åº
                return Object.entries(dailyMap)
                    .map(([date, pnl]) => ({ date, pnl: parseFloat(pnl.toFixed(2)) }))
                    .sort((a, b) => new Date(b.date) - new Date(a.date)); // æŒ‰æ—¥æœŸé™åº
            };


            window.updateTechnicalChart = updateTechnicalChart;

            // days å˜åŒ–æ—¶ç«‹å³åˆ·æ–°æŠ€æœ¯å›¾å¹¶é‡å»ºå®šæ—¶åˆ·æ–°
            useEffect(() => { loadData(); const timer = setInterval(loadData, 5000); return () => clearInterval(timer); }, [days]);
            useEffect(() => { loadAnalysisData(); }, []); // åˆå§‹åŠ è½½AIåˆ†æžæ•°æ®
            useEffect(() => { loadStrategyConfig(); }, []); // åˆå§‹åŠ è½½ç­–ç•¥é…ç½®
            useEffect(() => data.trades?.length && window.initPriceChart && setTimeout(() => window.initPriceChart(data.trades), 100), [data.trades]);
            useEffect(() => data.performance?.daily_pnl && window.initDailyPnlChart && setTimeout(() => window.initDailyPnlChart(data.performance.daily_pnl), 100), [data.performance]);
            useEffect(() => technicalData && setTimeout(() => updateTechnicalChart(), 100), [technicalData]);

            const { system, trades, performance } = data;
            const { btc_info: btc = {}, account_info: account = {}, ai_signal: aiSignal = {}, position = {} } = system;
            const tableProps = { rowKey: 'key', size: 'small', pagination: false };
            const statusCards = [
                ['â‚¿', 'BTCä»·æ ¼', btc.price ? `$${btc.price.toLocaleString()}` : '--', btc.change ? `${btc.change > 0 ? '+' : ''}${btc.change.toFixed(2)}%` : '--'],
                ['ðŸ’°', 'è´¦æˆ·æ€»æƒç›Š', account.equity !== undefined && account.equity !== null ? `${account.equity.toFixed(2)} USDT` : '--', account.balance !== undefined && account.balance !== null ? `å¯ç”¨: ${account.balance.toFixed(2)} USDT` : 'å¯ç”¨èµ„é‡‘'],
                ['ðŸ§ ', 'AIå†³ç­–', aiSignal.signal || '--', `ä¿¡å¿ƒ: ${aiSignal.confidence || '--'}`],
                ['ðŸ“ˆ', 'å½“å‰æŒä»“', position.side ? `${position.side === 'LONG' || position.side === 'long' ? 'å¤š' : 'ç©º'}ä»“ ${position.size || 0} å¼ ` : '--', position.unrealized_pnl !== undefined && position.unrealized_pnl !== null ? `ç›ˆäº: ${position.unrealized_pnl >= 0 ? '+' : ''}${position.unrealized_pnl.toFixed(4)} USDT` : '--']
            ];
            const perfStats = [
                [performance.total_trades || 0, 'æ€»äº¤æ˜“æ¬¡æ•°', 'ðŸ“Š'],
                [`${performance.total_trades > 0 ? ((performance.winning_trades || 0) / performance.total_trades * 100).toFixed(1) : 0}%`, 'èƒœçŽ‡', 'âœ…'],
                [(performance.total_pnl || 0).toFixed(2), 'æ€»ç›ˆäº', 'ðŸ’°'],
                [performance.total_trades > 0 ? (performance.total_pnl / performance.total_trades).toFixed(3) : '0.000', 'å¹³å‡ç›ˆäº', 'ðŸ“ˆ']
            ];

            const createStatCard = (icon, title, value, subtitle, idx) => {
                // åˆ¤æ–­æ˜¯å¦éœ€è¦é¢œè‰²
                let subtitleClass = 'text-sm text-2';
                if (idx === 3 && position.unrealized_pnl !== undefined && position.unrealized_pnl !== null) {
                    // å½“å‰æŒä»“çš„ç›ˆäºé¢œè‰²
                    subtitleClass = `text-sm font-bold ${position.unrealized_pnl >= 0 ? 'text-error' : 'text-success'}`;
                }
                return h(Card, { className: 'card' },
                    h('div', { className: 'card-header' },
                        h('span', { className: 'card-icon' }, icon),
                        h(Text, { type: 'secondary' }, title)
                    ),
                    h('div', { className: 'text-xl font-bold' }, value),
                    h('div', { className: subtitleClass }, subtitle)
                );
            };

            return h(Layout, { className: 'app-layout' },
                // é¡¶éƒ¨æ ‡é¢˜æ 
                h(Layout.Header, { className: 'app-header' },
                    h('div', { className: 'app-header-content' },
                        h(Space, null, h('span', null, 'ðŸ¤–'), h('span', { className: 'app-title' }, 'OKX BTCäº¤æ˜“æœºå™¨äºº')),
                        h(Space, null,
                            h('span', { className: 'status-online' }, 'è¿è¡Œä¸­'),
                            h('span', null, `æœ€åŽæ›´æ–°: ${moment().format('YYYY/M/D HH:mm:ss')}`),
                            h(Button, { type: 'primary', danger: true, onClick: handleLogout }, 'ç™»å‡º')
                        )
                    )
                ),

                h(Layout.Content, { className: 'app-content' },
                    // æŒ‡æ ‡å¡ç‰‡è¡Œ
                    h(Row, { gutter: [16, 16], className: 'mb-lg' },
                        ...statusCards.map(([icon, title, value, subtitle], idx) => 
                            h(Col, { xs: 24, sm: 12, lg: 6 }, createStatCard(icon, title, value, subtitle, idx))
                        )
                    ),

                    // æŠ€æœ¯æŒ‡æ ‡å›¾è¡¨è¡Œ
                    h(Row, { gutter: [16, 16], className: 'mb-lg' },
                        // æŠ€æœ¯æŒ‡æ ‡å›¾è¡¨ï¼ˆå ç”¨å…¨å®½ï¼‰
                        h(Col, { xs: 24 },
                            h(Card, { 
                                title: h('div', { className: 'card-title-flex' },
                                    h('div', { className: 'card-title-left' },
                                        h('span', null, `æŠ€æœ¯æŒ‡æ ‡åˆ†æž${technicalData?.current?.days ? 'ï¼ˆæœ€è¿‘' + technicalData.current.days + 'å¤©ï¼‰' : ''}`),
                                        // æ˜¾ç¤ºå®žæ—¶ç­–ç•¥ç‰ˆæœ¬
                                        h('span', { className: 'badge badge-primary' }, `å®žæ—¶ç­–ç•¥: ${liveStrategy.name}`)
                                    ),
                                    // å¸‚åœºæƒ…ç»ªä¿¡æ¯ - é å³å¯¹é½
                                    technicalData?.sentiment ? 
                                        h('div', { className: 'flex-center gap-sm text-sm' },
                                            h('span', { className: 'sentiment-label' }, 'å¸‚åœºæƒ…ç»ª:'),
                                            h('span', { className: technicalData.sentiment.trend === 'bullish' ? 'sentiment-bullish' : technicalData.sentiment.trend === 'bearish' ? 'sentiment-bearish' : 'sentiment-neutral' }, 
                                                `ä¹è§‚${(technicalData.sentiment.positive_ratio * 100).toFixed(1)}% æ‚²è§‚${(technicalData.sentiment.negative_ratio * 100).toFixed(1)}%`
                                            ),
                                            h('span', { className: `sentiment-net-value ${technicalData.sentiment.net_sentiment >= 0 ? 'text-success' : 'text-error'}` }, 
                                                `å‡€å€¼${technicalData.sentiment.net_sentiment >= 0 ? '+' : ''}${technicalData.sentiment.net_sentiment.toFixed(3)}`
                                            )
                                        ) : 
                                        h('span', { className: 'sentiment-loading' }, 'æƒ…ç»ªæ•°æ®èŽ·å–ä¸­...')
                                ),
                                className: 'chart-3xl' },
                                // æŽ§ä»¶å¸ƒå±€ï¼šåˆ†ä¸ºä¸¤è¡Œ
                                h('div', { className: 'mb-sm' },
                                    // ç¬¬ä¸€è¡Œï¼šå¤©æ•°ã€å¼ æ•°ã€ä¹°å…¥ã€å–å‡ºæŒ‰é’®
                                    h('div', { className: 'controls-row' },
                                        // å¤©æ•°è¾“å…¥æŽ§ä»¶ï¼ˆä½¿ç”¨é€šç”¨å‡½æ•°ï¼‰
                                        window.createNumberInput('å¤©æ•°', days, setDays, { min: 1, max: 300 }),
                                        // å¼ æ•°è¾“å…¥æŽ§ä»¶ï¼ˆä½¿ç”¨é€šç”¨å‡½æ•°ï¼‰
                                        window.createNumberInput('å¼ æ•°', manualTradeContracts, setManualTradeContracts, { 
                                            min: 0.01, max: 100, step: 0.01, precision: 2 
                                        }),
                                        // æ‰‹åŠ¨ä¹°å…¥æŒ‰é’®ï¼ˆä½¿ç”¨é€šç”¨äº¤æ˜“å‡½æ•°ï¼‰
                                        h(Button, {
                                            type: 'primary',
                                            size: 'small',
                                            className: 'btn-buy',
                                            onClick: () => window.executeTrade('BUY', manualTradeContracts, loadData)
                                        }, 'ðŸ“ˆ ä¹°å…¥'),
                                        // æ‰‹åŠ¨å–å‡ºæŒ‰é’®ï¼ˆä½¿ç”¨é€šç”¨äº¤æ˜“å‡½æ•°ï¼‰
                                        h(Button, {
                                            type: 'primary',
                                            danger: true,
                                            size: 'small',
                                            onClick: () => window.executeTrade('SELL', manualTradeContracts, loadData)
                                        }, 'ðŸ“‰ å–å‡º')
                                    ),
                                    // ç¬¬äºŒè¡Œï¼šæŒ‡æ ‡é€‰æ‹©å™¨ï¼ˆä½¿ç”¨é…ç½®åŒ–ç”Ÿæˆï¼‰
                                    window.createIndicatorControls('indicator', () => window.updateTechnicalChart())
                                ),
                                // å›¾è¡¨åŒºåŸŸ
                                h('div', { className: 'chart-md chart-wrapper' },
                                    h('canvas', { id: 'technicalChart' })
                                )
                            )
                        )
                    ),

                    // å›žæµ‹è§†å›¾ï¼ˆæŠ€æœ¯æŒ‡æ ‡å›¾ç»“æž„å®Œå…¨ä¸€è‡´ï¼‰
                    h(Row, { gutter: [16, 16], className: 'mb-lg' },
                        h(Col, { xs: 24 },
                            h(Card, { 
                                title: h('div', { className: 'card-title-flex' },
                                    h('span', null, `å›žæµ‹è§†å›¾ (æœ€è¿‘${backtestDays}å¤© Â· 15åˆ†é’Ÿ)`),
                                    // å¼€å§‹å¤æµ‹æŒ‰é’® - é å³å¯¹é½
                                    h(Space, { size: 'middle' },
                                        backtest.loading ? h('span', { className: 'text-warning' }, 'è®¡ç®—ä¸­â€¦') : null,
                                        h(Button, { type: 'primary', onClick: runBacktest, loading: backtest.loading }, 'å¼€å§‹å¤æµ‹')
                                    )
                                ),
                                minHeight: 450
                            },
                                // å›žæµ‹çš„æŽ§ä»¶åŒºåŸŸï¼šåˆ†ä¸ºä¸¤è¡Œ
                                h('div', { className: 'mb-sm' },
                                    // ç¬¬ä¸€è¡Œï¼šæ„°è‡³æ—¶é—´ã€å¤©æ•°ã€ç­–ç•¥
                                    h('div', { className: 'controls-row' },
                                        // æ„°è‡³æ—¶é—´è¾“å…¥æŽ§ä»¶
                                        h('div', { className: 'control-group' },
                                            window.createLabel('æ„°è‡³æ—¶é—´'),
                                            h('input', {
                                                type: 'datetime-local',
                                                className: 'datetime-input',
                                                value: backtestEndTime,
                                                onChange: (e) => setBacktestEndTime(e.target.value),
                                                title: 'å›žæµ‹æ„°è‡³æ—¶é—´ï¼Œé»˜è®¤ä¸ºå½“å‰æ—¶é—´'
                                            }),
                                            h(Button, {
                                                size: 'small',
                                                onClick: () => setBacktestEndTime(window.formatDateTime())
                                            }, 'å½“å‰')
                                        ),
                                        // å›žæµ‹å¤©æ•°è¾“å…¥æŽ§ä»¶ï¼ˆä½¿ç”¨é€šç”¨å‡½æ•°ï¼‰
                                        window.createNumberInput('å¤©æ•°', backtestDays, setBacktestDays, { min: 1, max: 300 }),
                                        // ç­–ç•¥ç‰ˆæœ¬é€‰æ‹©å™¨
                                        h('div', { className: 'control-group' },
                                            window.createLabel('ç­–ç•¥'),
                                            h(Select, {
                                                size: 'small',
                                                value: backtestStrategy,
                                                onChange: (value) => setBacktestStrategy(value),
                                                className: 'select-sm'
                                            }, 
                                                availableStrategies.map(strategy => 
                                                    h(Option, { 
                                                        key: strategy.version, 
                                                        value: strategy.version
                                                    }, strategy.version)
                                                )
                                            )
                                        )
                                    ),
                                    // ç¬¬äºŒè¡Œï¼šæŒ‡æ ‡é€‰æ‹©å™¨ï¼ˆä½¿ç”¨é…ç½®åŒ–ç”Ÿæˆï¼‰
                                    window.createIndicatorControls('indicator-bt', () => window.updateBacktestChart(backtest.data))
                                ),
                                // å›¾è¡¨å’Œå¤©æ”¶ç›Šåˆ—è¡¨åŒºåŸŸ - åˆ†ä¸ºä¸¤åˆ—
                                h(Row, { gutter: 16 },
                                    // å·¦ä¾§ï¼šå›¾è¡¨åŒºåŸŸ
                                    h(Col, { xs: 24, lg: 18 },
                                        h('div', { id: 'backtestTechnicalChart-scroll', className: 'chart-2xl chart-wrapper chart-scrollable' },
                                            h('div', { id: 'backtestTechnicalChart-inner', className: 'chart-inner-container' },
                                                h('canvas', { id: 'backtestTechnicalChart', className: 'w-full h-full' })
                                            )
                                        )
                                    ),
                                    // å³ä¾§ï¼šå¤©æ”¶ç›Šåˆ—è¡¨
                                    h(Col, { xs: 24, lg: 6 },
                                        backtest.data ? (() => {
                                            // ä½¿ç”¨åŽç«¯è¿”å›žçš„å®Œæ•´å¤©æ”¶ç›Šæ•°æ®ï¼ˆä¸å—20å¤©é™åˆ¶ï¼‰
                                            const dailyPnl = backtest.data.daily_pnl || [];
                                            const pageSize = 10;
                                            const totalPages = Math.ceil(dailyPnl.length / pageSize);
                                            const startIdx = (dailyPnlPage - 1) * pageSize;
                                            const endIdx = startIdx + pageSize;
                                            const currentData = dailyPnl.slice(startIdx, endIdx);
                                            
                                            return h('div', { className: 'chart-2xl flex-col' },
                                                h('h4', { className: 'text-md text-bold mb-md' }, 'å¤©æ”¶ç›Šåˆ—è¡¨'),
                                                h('div', { className: 'table-container' },
                                                    h('table', { className: 'table-simple' },
                                                        h('thead', null,
                                                            h('tr', null,
                                                                h('th', null, 'æ—¥æœŸ'),
                                                                h('th', { className: 'text-right' }, 'æ”¶ç›Š(USDT)')
                                                            )
                                                        ),
                                                        h('tbody', null,
                                                            currentData.length > 0 ? currentData.map((item, idx) =>
                                                                h('tr', { 
                                                                    key: item.date
                                                                },
                                                                    h('td', null, item.date),
                                                                    h('td', { className: `text-right text-bold ${item.pnl >= 0 ? 'text-error' : 'text-success'}` }, `${item.pnl >= 0 ? '+' : ''}${item.pnl}`)
                                                                )
                                                            ) : h('tr', null,
                                                                h('td', { colSpan: 2, className: 'text-center text-disabled p-lg' }, 'æš‚æ— æ•°æ®')
                                                            )
                                                        )
                                                    )
                                                ),
                                                totalPages > 1 ? h('div', { className: 'text-center mt-sm' },
                                                    h(antd.Pagination, {
                                                        simple: true,
                                                        size: 'small',
                                                        current: dailyPnlPage,
                                                        total: dailyPnl.length,
                                                        pageSize: pageSize,
                                                        onChange: (page) => setDailyPnlPage(page)
                                                    })
                                                ) : null
                                            );
                                        })() : h('div', { className: 'chart-2xl loading-container text-md' }, 'è¿è¡Œå›žæµ‹åŽæ˜¾ç¤ºå¤©æ”¶ç›Š')
                                    )
                                ),
                                backtest.data ? h('div', { className: 'summary-box mt-sm' },
                                    h(Space, { size: 'middle', wrap: true },
                                        h('span', null, `æ•°æ®ç‚¹: ${backtest.data.summary.data_points}`),
                                        h('span', null, `ä¿¡å·æ•°: ${backtest.data.summary.total_signals}`),
                                        h('span', null, `å·²å¹³ä»“: ${backtest.data.summary.closed_trades}`),
                                        h('span', { className: `text-bold ${backtest.data.summary.net_pnl_total >= 0 ? 'text-error' : 'text-success'}` }, `å‡€æ”¶ç›Š: ${backtest.data.summary.net_pnl_total} USDT`),
                                        h('span', { className: backtest.data.summary.gross_pnl_total >= 0 ? 'text-error' : 'text-success' }, `æ¯›æ”¶ç›Š: ${backtest.data.summary.gross_pnl_total} USDT`),
                                        h('span', { className: 'text-warning' }, `æ‰‹ç»­è´¹: ${backtest.data.summary.total_fees} USDT`),
                                        h('span', null, `èƒœçŽ‡: ${backtest.data.summary.win_rate}%`),
                                        h('span', null, `å‡(æ¯›): ${backtest.data.summary.avg_pnl_gross} USDT`),
                                        h('span', null, `å‡(å‡€): ${backtest.data.summary.avg_pnl_net} USDT`)
                                    )
                                ) : null
                            )
                        )
                    ),

                    // å›¾è¡¨å’Œç»©æ•ˆè¡Œ
                    h(Row, { gutter: [16, 16], className: 'mb-lg' },
                        h(Col, { xs: 24, lg: 16 },
                            h(Card, { title: 'ä»·æ ¼èµ°åŠ¿ & äº¤æ˜“ä¿¡å·' },
                                h('div', { className: 'chart-md chart-wrapper' },
                                    h('canvas', { id: 'priceChart' })
                                )
                            )
                        ),
                        h(Col, { xs: 24, lg: 8 },
                            h(Card, { title: 'äº¤æ˜“ç»©æ•ˆ', className: 'chart' },
                                // ç»Ÿè®¡æŒ‡æ ‡è¡Œ
                                h(Row, { gutter: [8, 8], className: 'mb-lg' },
                                    ...perfStats.map((v, i) => {
                                        // è®¡ç®—é¢œè‰²
                                        let valueColor = '#1890ff';  // é»˜è®¤é¢œè‰²
                                        if (v[1].includes('æ€»ç›ˆäº') || v[1].includes('å¹³å‡ç›ˆäº')) {
                                            const val = parseFloat(v[0]);
                                            valueColor = val >= 0 ? '#f5222d' : '#52c41a';
                                        } else if (v[1].includes('èƒœçŽ‡')) {
                                            valueColor = '#52c41a';
                                        }
                                        return h(Col, { xs: 12, key: i },
                                            h(Card, { bordered: true, size: 'small' },
                                                h(Statistic, { 
                                                    title: v[1], 
                                                    value: v[0], 
                                                    prefix: v[2], 
                                                    suffix: v[1].includes('ç›ˆäº') ? 'USDT' : '', 
                                                    valueStyle: { color: valueColor, fontSize: '18px' } 
                                                })
                                            )
                                        );
                                    })
                                ),
                                // æ¯æ—¥ç›ˆäºå›¾è¡¨
                                h('div', { className: 'p-md daily-chart-box' },
                                    h(Text, { strong: true, className: 'mb-sm d-block' }, 'æ¯æ—¥ç›ˆäº'),
                                    h('div', { className: 'chart-sm' },
                                        h('canvas', { id: 'dailyPnlChart' })
                                    )
                                )
                            )
                        )
                    ),

                    h(Row, { gutter: [16, 16] },
                        h(Col, { xs: 24, lg: 12 },
                            h(Card, { title: 'æœ€è¿‘äº¤æ˜“è®°å½•', className: 'chart-lg' },
                                h(Table, {
                                    dataSource: trades.slice(-10).reverse().map((item, i) => ({ ...item, key: item.id || i })),
                                    columns: tradeColumns, ...tableProps,
                                    locale: { emptyText: 'æš‚æ— äº¤æ˜“è®°å½•' }, scroll: { y: 300 }
                                })
                            )
                        ),
                        h(Col, { xs: 24, lg: 12 },
                            h(Card, { title: 'AIåˆ†æžè¯¦æƒ…', className: 'chart-lg' },
                                h(Tabs, { 
                                    defaultActiveKey: '1', 
                                    size: 'small',
                                    items: [
                                        {
                                            key: '1',
                                            label: 'å½“å‰åˆ†æž',
                                            children: h(Space, { direction: 'vertical', className: 'w-full', size: 'middle' },
                                                h('div', null,
                                                    h(Text, { strong: true }, 'å†³ç­–ç†ç”±'),
                                                    h('div', { className: 'box box-scroll mt' },
                                                        aiSignal.reason || 'ç³»ç»Ÿæ­£åœ¨åˆ†æžå¸‚åœºæ•°æ®ï¼Œè¯·ç¨å€™...'
                                                    )
                                                ),
                                                h(Row, { gutter: 16 },
                                                    ...['æ­¢æŸä»·æ ¼', 'æ­¢ç›ˆä»·æ ¼'].map((label, i) => 
                                                        h(Col, { span: 12 },
                                                            h(Text, { strong: true }, label),
                                                            h('div', { className: `text-lg font-bold mt ${i ? 'text-success' : 'text-error'}` },
                                                                (i ? aiSignal.take_profit : aiSignal.stop_loss) ? `$${(i ? aiSignal.take_profit : aiSignal.stop_loss).toLocaleString()}` : '--'
                                                            )
                                                        )
                                                    )
                                                ),
                                                h('div', null,
                                                    h(Text, { strong: true }, 'æŠ€æœ¯æŒ‡æ ‡')
                                                )
                                            )
                                        },
                                        {
                                            key: '2',
                                            label: 'åŽ†å²è®°å½•',
                                            children: h('div', { className: 'h-full' },
                                                h(Table, {
                                                    dataSource: analysisData.data?.map((item, i) => ({ ...item, key: item.id || i })) || [],
                                                    expandable: {
                                                        expandedRowRender: record => h('div', { className: 'box box-sm' }, record.reason || 'æš‚æ— è¯¦ç»†ä¿¡æ¯'),
                                                        rowExpandable: record => !!(record.reason)
                                                    },
                                                    columns: analysisColumns, 
                                                    rowKey: 'key', 
                                                    size: 'small', 
                                                    pagination: false,
                                                    locale: { emptyText: 'æš‚æ— åˆ†æžè®°å½•' }, 
                                                    scroll: { y: 200 }
                                                }),
                                                // åˆ†é¡µç»„ä»¶
                                                analysisData.pagination?.total_count > 0 && h('div', { className: 'text-center mt border-t' },
                                                    h(Pagination, {
                                                        current: analysisData.pagination.page,
                                                        pageSize: analysisData.pagination.page_size,
                                                        total: analysisData.pagination.total_count,
                                                        showSizeChanger: true,
                                                        showQuickJumper: true,
                                                        showTotal: (total, range) => `ç¬¬ ${range[0]}-${range[1]} æ¡ï¼Œå…± ${total} æ¡`,
                                                        pageSizeOptions: ['5', '10', '20', '50'],
                                                        size: 'small',
                                                        onChange: (page, pageSize) => {
                                                            setAnalysisPage(page);
                                                            loadAnalysisData(page, pageSize);
                                                        },
                                                        onShowSizeChange: (current, size) => {
                                                            setAnalysisPage(1);
                                                            loadAnalysisData(1, size);
                                                        }
                                                    })
                                                )
                                            )
                                        }
                                    ]
                                })
                            )
                        )
                    )
                )
            );
        }

        ReactDOM.render(h(App), document.getElementById('root'));
    </script>
</body>
</html>
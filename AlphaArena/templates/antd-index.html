<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OKX BTCäº¤æ˜“æœºå™¨äºº - æ™ºèƒ½äº¤æ˜“ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/static/css/antd.css" />
    <link rel="stylesheet" href="/static/css/custom.css" />
    <script crossorigin src="/static/js/react.production.min.js"></script>
    <script crossorigin src="/static/js/react-dom.production.min.js"></script>
    <script src="/static/js/babel.min.js"></script>
    <script src="/static/js/moment.min.js"></script>
    <script src="/static/js/antd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1/dist/chartjs-adapter-moment.min.js"></script>
    <script type="text/babel" src="/static/js/app.js"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
    const { Layout, Card, Row, Col, Table, Button, message, Typography, Space, Tabs, Statistic, Pagination, InputNumber, Select } = antd;
        const { Text } = Typography;
        const { Option } = Select;

        function App() {
            const [data, setData] = useState({ system: {}, trades: [], performance: {}, analysis: [] });
            const [technicalData, setTechnicalData] = useState(null);
            const [analysisPage, setAnalysisPage] = useState(1);
            const [days, setDays] = useState(1); // æŠ€æœ¯å›¾çª—å£å¤©æ•°ï¼ˆé»˜è®¤1ï¼‰
            const [manualTradeContracts, setManualTradeContracts] = useState(0.01); // æ‰‹åŠ¨äº¤æ˜“å¼ æ•°ï¼ˆé»˜è®¤0.01å¼ ï¼‰
            // å›æµ‹æ•°æ®çŠ¶æ€
            const [backtest, setBacktest] = useState({ loading: false, data: null, error: null });
            const [backtestDays, setBacktestDays] = useState(3); // å›æµ‹å¤©æ•°ï¼ˆé»˜è®¤2ï¼‰
            const [dailyPnlPage, setDailyPnlPage] = useState(1); // å¤©æ”¶ç›Šåˆ—è¡¨é¡µç 
            // å›æµ‹æˆªè‡³æ—¶é—´ - é»˜è®¤ä¸ºå½“å‰æ—¶é—´ï¼ˆæ ¼å¼: YYYY-MM-DDTHH:MMï¼‰
            const [backtestEndTime, setBacktestEndTime] = useState(() => {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            });
            const [backtestStrategy, setBacktestStrategy] = useState('strategy_decision_v2'); // å›æµ‹ç­–ç•¥ç‰ˆæœ¬
            const [analysisData, setAnalysisData] = useState({ data: [], pagination: {} });
            // ç­–ç•¥é…ç½®çŠ¶æ€
            const [liveStrategy, setLiveStrategy] = useState({ version: 'strategy_decision_v2', name: 'strategy_decision_v2' });
            const [availableStrategies, setAvailableStrategies] = useState([]);
            
            const handleLogout = () => {
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('username');
                window.location.href = '/';
            };

            // åŠ è½½ç­–ç•¥é…ç½®
            const loadStrategyConfig = async () => {
                try {
                    const response = await fetch(`/api/strategy-config?_t=${Date.now()}`);
                    const configData = await response.json();
                    
                    // è®¾ç½®å®æ—¶ç­–ç•¥ä¿¡æ¯ï¼ˆåªæ˜¾ç¤ºç‰ˆæœ¬å·ï¼‰
                    const liveVersion = configData.live_trading?.version || 'strategy_decision_v2';
                    
                    setLiveStrategy({
                        version: liveVersion,
                        name: liveVersion  // ç›´æ¥æ˜¾ç¤ºç‰ˆæœ¬å·
                    });
                    
                    // åªæ˜¾ç¤ºå¯ç”¨çš„ç­–ç•¥ç‰ˆæœ¬
                    const enabled = (configData.available_versions || []).filter(v => v.enabled);
                    setAvailableStrategies(enabled);
                    
                    // è®¾ç½®å›æµ‹é»˜è®¤ç‰ˆæœ¬
                    if (configData.backtest_default?.version) {
                        setBacktestStrategy(configData.backtest_default.version);
                    }
                } catch (error) {
                    console.error('ç­–ç•¥é…ç½®åŠ è½½å¤±è´¥:', error);
                }
            };

            // åŠ è½½AIåˆ†ææ•°æ®ï¼ˆåˆ†é¡µï¼‰
            const loadAnalysisData = async (page = 1, pageSize = 10) => {
                try {
                    const response = await fetch(`/api/ai-analysis-history?page=${page}&page_size=${pageSize}&_t=${Date.now()}`);
                    const result = await response.json();
                    setAnalysisData(result);
                } catch (error) {
                    console.error('AIåˆ†ææ•°æ®åŠ è½½å¤±è´¥:', error);
                    message.error('AIåˆ†ææ•°æ®åŠ è½½å¤±è´¥');
                }
            };

            const loadData = async () => {
                try {
                    const t = Date.now();
                    const [system, trades, performance, technical] = await Promise.all([
                        fetch(`/api/system-status?_t=${t}`).then(r => r.json()),
                        fetch(`/api/trade-history?_t=${t}`).then(r => r.json()),
                        fetch(`/api/performance?_t=${t}`).then(r => r.json()),
                        fetch(`/api/technical-chart?days=${days}&_t=${t}`).then(r => r.json())
                    ]);
                    setData({ system: system || {}, trades: trades || [], performance: performance || {} });
                    setTechnicalData(technical);
                    
                    // åŒæ—¶åŠ è½½AIåˆ†ææ•°æ®
                    await loadAnalysisData(analysisPage);
                } catch (error) {
                    console.error('æ•°æ®åŠ è½½å¤±è´¥:', error);
                    message.error('æ•°æ®åŠ è½½å¤±è´¥');
                }
            };

            const updateTechnicalChart = () => {
                if (!technicalData) return;
                const checkboxes = document.querySelectorAll('input[data-indicator]');
                const selected = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.dataset.indicator);
                window.initTechnicalChart && window.initTechnicalChart(technicalData, selected);
            };

            const runBacktest = async () => {
                try {
                    setBacktest(prev => ({ ...prev, loading: true, error: null }));
                    const res = await fetch('/api/backtest', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            days: backtestDays, 
                            interval: '15m',
                            strategy_version: backtestStrategy,
                            end_time: backtestEndTime || undefined  // æˆªè‡³æ—¶é—´ï¼ˆç©ºåˆ™ä½¿ç”¨å½“å‰æ—¶é—´ï¼‰
                        })
                    });
                    const result = await res.json();
                    if (!res.ok) throw new Error(result.error || 'å›æµ‹å¤±è´¥');
                    setBacktest({ loading: false, data: result, error: null });
                    // æ¸²æŸ“å›æµ‹æŠ€æœ¯å›¾ï¼ˆä¸æŠ€æœ¯æŒ‡æ ‡åˆ†æä¸€è‡´ï¼‰
                    setTimeout(() => {
                        const cbs = document.querySelectorAll('input[data-indicator-bt]');
                        const selected = Array.from(cbs).filter(cb => cb.checked).map(cb => cb.dataset.indicatorBt);
                        window.initTechnicalChart && window.initTechnicalChart(result.chart, selected, 'backtestTechnicalChart');
                    }, 50);
                    message.success('å›æµ‹å®Œæˆ');
                } catch (err) {
                    console.error('å›æµ‹å¤±è´¥:', err);
                    setBacktest({ loading: false, data: null, error: err.message || String(err) });
                    message.error('å›æµ‹å¤±è´¥: ' + (err.message || err));
                }
            };

            // è®¡ç®—å¤©æ”¶ç›Šæ•°æ®
            const calculateDailyPnl = (trades) => {
                if (!trades || trades.length === 0) return [];
                
                const dailyMap = {};
                trades.forEach(trade => {
                    if (trade.pnl !== null && trade.pnl !== undefined) {
                        const date = trade.timestamp.split(' ')[0]; // æå–æ—¥æœŸéƒ¨åˆ† YYYY-MM-DD
                        if (!dailyMap[date]) {
                            dailyMap[date] = 0;
                        }
                        dailyMap[date] += trade.pnl;
                    }
                });
                
                // è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
                return Object.entries(dailyMap)
                    .map(([date, pnl]) => ({ date, pnl: parseFloat(pnl.toFixed(2)) }))
                    .sort((a, b) => new Date(b.date) - new Date(a.date)); // æŒ‰æ—¥æœŸé™åº
            };


            window.updateTechnicalChart = updateTechnicalChart;

            // days å˜åŒ–æ—¶ç«‹å³åˆ·æ–°æŠ€æœ¯å›¾å¹¶é‡å»ºå®šæ—¶åˆ·æ–°
            useEffect(() => { loadData(); const timer = setInterval(loadData, 5000); return () => clearInterval(timer); }, [days]);
            useEffect(() => { loadAnalysisData(); }, []); // åˆå§‹åŠ è½½AIåˆ†ææ•°æ®
            useEffect(() => { loadStrategyConfig(); }, []); // åˆå§‹åŠ è½½ç­–ç•¥é…ç½®
            useEffect(() => data.trades?.length && window.initPriceChart && setTimeout(() => window.initPriceChart(data.trades), 100), [data.trades]);
            useEffect(() => data.performance?.daily_pnl && window.initDailyPnlChart && setTimeout(() => window.initDailyPnlChart(data.performance.daily_pnl), 100), [data.performance]);
            useEffect(() => technicalData && setTimeout(() => updateTechnicalChart(), 100), [technicalData]);

            const { system, trades, performance } = data;
            const { btc_info: btc = {}, account_info: account = {}, ai_signal: aiSignal = {}, position = {} } = system;
            const tableProps = { rowKey: 'key', size: 'small', pagination: false };
            const statusCards = [
                ['â‚¿', 'BTCä»·æ ¼', btc.price ? `$${btc.price.toLocaleString()}` : '--', btc.change ? `${btc.change > 0 ? '+' : ''}${btc.change.toFixed(2)}%` : '--', '#f7931a'],
                ['ğŸ’°', 'è´¦æˆ·ä½™é¢', account.balance ? `${account.balance.toFixed(2)} USDT` : '--', 'å¯ç”¨èµ„é‡‘', '#52c41a'],
                ['ğŸ§ ', 'AIå†³ç­–', aiSignal.signal || '--', `ä¿¡å¿ƒ: ${aiSignal.confidence || '--'}`, '#722ed1'],
                ['ğŸ“ˆ', 'å½“å‰æŒä»“', position.side ? `${position.side === 'LONG' || position.side === 'long' ? 'å¤š' : 'ç©º'}ä»“ ${position.size || 0} å¼ ` : '--', position.unrealized_pnl ? `ç›ˆäº: ${position.unrealized_pnl.toFixed(4)} USDT` : '--', position.unrealized_pnl != null ? (position.unrealized_pnl >= 0 ? '#f5222d' : '#52c41a') : '#1890ff']
            ];
            const perfStats = [
                [performance.total_trades || 0, 'æ€»äº¤æ˜“æ¬¡æ•°', 'ğŸ“Š', '#1890ff'],
                [`${performance.total_trades > 0 ? ((performance.winning_trades || 0) / performance.total_trades * 100).toFixed(1) : 0}%`, 'èƒœç‡', 'âœ…', '#52c41a'],
                [(performance.total_pnl || 0).toFixed(2), 'æ€»ç›ˆäº', 'ğŸ’°', performance.total_pnl >= 0 ? '#f5222d' : '#52c41a'],
                [performance.total_trades > 0 ? (performance.total_pnl / performance.total_trades).toFixed(3) : '0.000', 'å¹³å‡ç›ˆäº', 'ğŸ“ˆ', performance.total_pnl >= 0 ? '#f5222d' : '#52c41a']
            ];

            const createStatCard = (icon, title, value, subtitle, color) => 
                h(Card, { className: 'balance-card' },
                    h('div', { style: { display: 'flex', alignItems: 'center', marginBottom: 8 } },
                        h('span', { style: { fontSize: '24px', marginRight: 8, color } }, icon),
                        h(Text, { type: 'secondary' }, title)
                    ),
                    h('div', { className: 'big-number' }, value),
                    h('div', { style: { fontSize: '12px', color: subtitle.includes('ç›ˆäº:') ? color : '#666' } }, subtitle)
                );

            return h(Layout, { style: { minHeight: '100vh', background: '#f5f5f5' } },
                // é¡¶éƒ¨æ ‡é¢˜æ 
                h(Layout.Header, { style: { background: '#fff', padding: '0 50px', boxShadow: '0 2px 8px #0001' } },
                    h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', height: '64px' } },
                        h(Space, null, h('span', null, 'ğŸ¤–'), h('span', { style: { fontSize: '18px', fontWeight: 'bold', color: '#1890ff' } }, 'OKX BTCäº¤æ˜“æœºå™¨äºº')),
                        h(Space, null,
                            h('span', { className: 'status-online' }, 'è¿è¡Œä¸­'),
                            h('span', null, `æœ€åæ›´æ–°: ${moment().format('YYYY/M/D HH:mm:ss')}`),
                            h(Button, { type: 'primary', danger: true, onClick: handleLogout }, 'ç™»å‡º')
                        )
                    )
                ),

                h(Layout.Content, { style: { maxWidth: 1400, margin: '24px auto', padding: '0 24px', width: '100%' } },
                    // æŒ‡æ ‡å¡ç‰‡è¡Œ
                    h(Row, { gutter: [16, 16], style: { marginBottom: 16 } },
                        ...statusCards.map(([icon, title, value, subtitle, color]) => 
                            h(Col, { xs: 24, sm: 12, lg: 6 }, createStatCard(icon, title, value, subtitle, color))
                        )
                    ),

                    // æŠ€æœ¯æŒ‡æ ‡å›¾è¡¨è¡Œ
                    h(Row, { gutter: [16, 16], style: { marginBottom: 16 } },
                        // æŠ€æœ¯æŒ‡æ ‡å›¾è¡¨ï¼ˆå ç”¨å…¨å®½ï¼‰
                        h(Col, { xs: 24 },
                            h(Card, { 
                                title: h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '8px' } },
                                    h('div', { style: { display: 'flex', alignItems: 'center', gap: '12px' } },
                                        h('span', null, `æŠ€æœ¯æŒ‡æ ‡åˆ†æ${technicalData?.current?.days ? 'ï¼ˆæœ€è¿‘' + technicalData.current.days + 'å¤©ï¼‰' : ''}`),
                                        // æ˜¾ç¤ºå®æ—¶ç­–ç•¥ç‰ˆæœ¬
                                        h('span', { 
                                            style: { 
                                                fontSize: '12px', 
                                                color: '#1890ff', 
                                                background: '#e6f7ff', 
                                                padding: '2px 8px', 
                                                borderRadius: '4px',
                                                border: '1px solid #91d5ff'
                                            } 
                                        }, `å®æ—¶ç­–ç•¥: ${liveStrategy.name}`)
                                    ),
                                    // å¸‚åœºæƒ…ç»ªä¿¡æ¯
                                    technicalData?.sentiment ? 
                                        h('div', { style: { fontSize: '12px', display: 'flex', alignItems: 'center', gap: '8px' } },
                                            h('span', { style: { color: '#666' } }, 'å¸‚åœºæƒ…ç»ª:'),
                                            h('span', { 
                                                style: { 
                                                    color: technicalData.sentiment.trend === 'bullish' ? '#52c41a' : 
                                                           technicalData.sentiment.trend === 'bearish' ? '#f5222d' : '#faad14',
                                                    fontWeight: 'bold'
                                                }
                                            }, 
                                                `ä¹è§‚${(technicalData.sentiment.positive_ratio * 100).toFixed(1)}% æ‚²è§‚${(technicalData.sentiment.negative_ratio * 100).toFixed(1)}%`
                                            ),
                                            h('span', { 
                                                style: { 
                                                    color: technicalData.sentiment.net_sentiment >= 0 ? '#52c41a' : '#f5222d',
                                                    fontSize: '11px'
                                                }
                                            }, 
                                                `å‡€å€¼${technicalData.sentiment.net_sentiment >= 0 ? '+' : ''}${technicalData.sentiment.net_sentiment.toFixed(3)}`
                                            )
                                        ) : 
                                        h('span', { style: { fontSize: '12px', color: '#999' } }, 'æƒ…ç»ªæ•°æ®è·å–ä¸­...')
                                ),
                                style: { height: 450 } },
                                // æ§ä»¶å¸ƒå±€ï¼šåˆ†ä¸ºä¸¤è¡Œ
                                h('div', { style: { marginBottom: '8px' } },
                                    // ç¬¬ä¸€è¡Œï¼šå¤©æ•°ã€å¼ æ•°ã€ä¹°å…¥ã€å–å‡ºæŒ‰é’®
                                    h('div', { style: { marginBottom: '8px' } },
                                        // å¤©æ•°è¾“å…¥æ§ä»¶ï¼ˆ1~300ï¼Œé»˜è®¤1ï¼‰
                                        h('div', { style: { display: 'inline-flex', alignItems: 'center', gap: 8, marginRight: 12 } },
                                            h('span', { style: { fontSize: '12px', color: '#666' } }, 'å¤©æ•°'),
                                            h(InputNumber, {
                                                min: 1, max: 300, size: 'small', value: days,
                                                onChange: (v) => {
                                                    const nv = Number(v) || 1;
                                                    if (nv < 1 || nv > 300) return;
                                                    setDays(nv);
                                                },
                                                style: { width: 80 }
                                            })
                                        ),
                                        // å¼ æ•°è¾“å…¥æ§ä»¶ï¼ˆ0.01~100ï¼Œé»˜è®¤0.01ï¼Œæ­¥é•¿0.01ï¼‰
                                        h('div', { style: { display: 'inline-flex', alignItems: 'center', gap: 8, marginRight: 12 } },
                                            h('span', { style: { fontSize: '12px', color: '#666' } }, 'å¼ æ•°'),
                                            h(InputNumber, {
                                                min: 0.01, max: 100, size: 'small', 
                                                value: manualTradeContracts,
                                                step: 0.01,
                                                precision: 2,
                                                onChange: (v) => {
                                                    const nv = Number(v) || 0.01;
                                                    if (nv < 0.01 || nv > 100) return;
                                                    setManualTradeContracts(nv);
                                                },
                                                style: { width: 80 }
                                            })
                                        ),
                                        // æ‰‹åŠ¨ä¹°å…¥æŒ‰é’®
                                        h(Button, {
                                            type: 'primary',
                                            size: 'small',
                                            style: { marginRight: 8, backgroundColor: '#52c41a', borderColor: '#52c41a' },
                                            onClick: async () => {
                                                const confirmed = await new Promise(resolve => {
                                                    antd.Modal.confirm({
                                                        title: 'ç¡®è®¤æ‰‹åŠ¨ä¹°å…¥',
                                                        content: `ç¡®å®šè¦ä¹°å…¥ ${manualTradeContracts} å¼  (${(manualTradeContracts * 0.01).toFixed(4)} BTC) å—ï¼Ÿ`,
                                                        okText: 'ç¡®è®¤ä¹°å…¥',
                                                        cancelText: 'å–æ¶ˆ',
                                                        onOk: () => resolve(true),
                                                        onCancel: () => resolve(false)
                                                    });
                                                });
                                                if (!confirmed) return;
                                                
                                                try {
                                                    const res = await fetch('/api/manual-trade', {
                                                        method: 'POST',
                                                        headers: { 'Content-Type': 'application/json' },
                                                        body: JSON.stringify({ 
                                                            signal: 'BUY',
                                                            contracts: manualTradeContracts 
                                                        })
                                                    });
                                                    const result = await res.json();
                                                    if (res.ok) {
                                                        message.success(`ä¹°å…¥æˆåŠŸï¼š${manualTradeContracts} å¼ `);
                                                        loadData(); // åˆ·æ–°æ•°æ®
                                                    } else {
                                                        message.error(`ä¹°å…¥å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}`);
                                                    }
                                                } catch (err) {
                                                    message.error(`ä¹°å…¥å¤±è´¥: ${err.message}`);
                                                }
                                            }
                                        }, 'ğŸ“ˆ ä¹°å…¥'),
                                        // æ‰‹åŠ¨å–å‡ºæŒ‰é’®
                                        h(Button, {
                                            type: 'primary',
                                            danger: true,
                                            size: 'small',
                                            onClick: async () => {
                                                const confirmed = await new Promise(resolve => {
                                                    antd.Modal.confirm({
                                                        title: 'ç¡®è®¤æ‰‹åŠ¨å–å‡º',
                                                        content: `ç¡®å®šè¦å–å‡º ${manualTradeContracts} å¼  (${(manualTradeContracts * 0.01).toFixed(4)} BTC) å—ï¼Ÿ`,
                                                        okText: 'ç¡®è®¤å–å‡º',
                                                        cancelText: 'å–æ¶ˆ',
                                                        onOk: () => resolve(true),
                                                        onCancel: () => resolve(false)
                                                    });
                                                });
                                                if (!confirmed) return;
                                                
                                                try {
                                                    const res = await fetch('/api/manual-trade', {
                                                        method: 'POST',
                                                        headers: { 'Content-Type': 'application/json' },
                                                        body: JSON.stringify({ 
                                                            signal: 'SELL',
                                                            contracts: manualTradeContracts 
                                                        })
                                                    });
                                                    const result = await res.json();
                                                    if (res.ok) {
                                                        message.success(`å–å‡ºæˆåŠŸï¼š${manualTradeContracts} å¼ `);
                                                        loadData(); // åˆ·æ–°æ•°æ®
                                                    } else {
                                                        message.error(`å–å‡ºå¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}`);
                                                    }
                                                } catch (err) {
                                                    message.error(`å–å‡ºå¤±è´¥: ${err.message}`);
                                                }
                                            }
                                        }, 'ğŸ“‰ å–å‡º')
                                    ),
                                    // ç¬¬äºŒè¡Œï¼šæŒ‡æ ‡é€‰æ‹©å™¨
                                    h('div', { className: 'indicator-controls' },
                                    h('label', null,
                                        h('input', { 
                                            type: 'checkbox', 
                                            defaultChecked: true,
                                            onChange: (e) => window.updateTechnicalChart(),
                                            'data-indicator': 'price'
                                        }),
                                        'ä»·æ ¼æ›²çº¿'
                                    ),
                                    h('label', null,
                                        h('input', { 
                                            type: 'checkbox',
                                            onChange: (e) => window.updateTechnicalChart(),
                                            'data-indicator': 'sma5'
                                        }),
                                        'SMA5'
                                    ),
                                    h('label', null,
                                        h('input', { 
                                            type: 'checkbox',
                                            onChange: (e) => window.updateTechnicalChart(),
                                            'data-indicator': 'sma20'
                                        }),
                                        'SMA20'
                                    ),
                                    h('label', null,
                                        h('input', { 
                                            type: 'checkbox',
                                            onChange: (e) => window.updateTechnicalChart(),
                                            'data-indicator': 'sma50'
                                        }),
                                        'SMA50'
                                    ),
                                    h('label', null,
                                        h('input', { 
                                            type: 'checkbox',
                                            defaultChecked: true,
                                            onChange: (e) => window.updateTechnicalChart(),
                                            'data-indicator': 'bollinger'
                                        }),
                                        'å¸ƒæ—å¸¦é€šé“'
                                    ),
                                    h('label', null,
                                        h('input', { 
                                            type: 'checkbox',
                                            onChange: (e) => window.updateTechnicalChart(),
                                            'data-indicator': 'macd'
                                        }),
                                        'MACDçº¿'
                                    ),
                                    h('label', null,
                                        h('input', { 
                                            type: 'checkbox',
                                            defaultChecked: true,
                                            onChange: (e) => window.updateTechnicalChart(),
                                            'data-indicator': 'macd_signal'
                                        }),
                                        'MACDä¿¡å·çº¿'
                                    ),
                                    h('label', null,
                                        h('input', { 
                                            type: 'checkbox',
                                            defaultChecked: true,
                                            onChange: (e) => window.updateTechnicalChart(),
                                            'data-indicator': 'macd_histogram'
                                        }),
                                        'MACDæŸ±çŠ¶å›¾'
                                    ),
                                    h('label', null,
                                        h('input', { 
                                            type: 'checkbox',
                                            onChange: (e) => window.updateTechnicalChart(),
                                            'data-indicator': 'rsi'
                                        }),
                                        'RSI'
                                    ),
                                    h('label', null,
                                        h('input', { 
                                            type: 'checkbox',
                                            onChange: (e) => window.updateTechnicalChart(),
                                            'data-indicator': 'scores'
                                        }),
                                        'Scoreè¯„åˆ†'
                                    ),
                                    h('label', null,
                                        h('input', { 
                                            type: 'checkbox',
                                            defaultChecked: true,
                                            onChange: (e) => window.updateTechnicalChart(),
                                            'data-indicator': 'decisions'
                                        }),
                                        'äº¤æ˜“å†³ç­–'
                                    )
                                    )
                                ),
                                // å›¾è¡¨åŒºåŸŸï¼ˆè¿˜åŸä¸ºæ— æ¨ªå‘æ»šåŠ¨ï¼‰
                                h('div', { style: { height: '280px', padding: '10px' } },
                                    h('canvas', { id: 'technicalChart' })
                                )
                            )
                        )
                    ),

                    // å›æµ‹è§†å›¾ï¼ˆæŠ€æœ¯æŒ‡æ ‡å›¾ç»“æ„å®Œå…¨ä¸€è‡´ï¼‰
                    h(Row, { gutter: [16, 16], style: { marginBottom: 16 } },
                        h(Col, { xs: 24 },
                            h(Card, { 
                                title: h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center' } },
                                    h('span', null, `å›æµ‹è§†å›¾ (æœ€è¿‘${backtestDays}å¤© Â· 15åˆ†é’Ÿ)`),
                                    h(Space, { size: 'middle' },
                                        backtest.loading ? h('span', { style: { color: '#faad14' } }, 'è®¡ç®—ä¸­â€¦') : null,
                                        h(Button, { type: 'primary', onClick: runBacktest, loading: backtest.loading }, 'å¼€å§‹å¤æµ‹')
                                    )
                                ),
                                style: { minHeight: 450 }
                            },
                                // å›æµ‹çš„æ§ä»¶åŒºåŸŸï¼šåˆ†ä¸ºä¸¤è¡Œ
                                h('div', { style: { marginBottom: '8px' } },
                                    // ç¬¬ä¸€è¡Œï¼šæˆªè‡³æ—¶é—´ã€å¤©æ•°ã€ç­–ç•¥
                                    h('div', { style: { marginBottom: '8px' } },
                                        // æˆªè‡³æ—¶é—´è¾“å…¥æ§ä»¶
                                        h('div', { style: { display: 'inline-flex', alignItems: 'center', gap: 8, marginRight: 12 } },
                                            h('span', { style: { fontSize: '12px', color: '#666' } }, 'æˆªè‡³æ—¶é—´'),
                                            h('input', {
                                                type: 'datetime-local',
                                                style: { fontSize: '12px', padding: '4px 8px', border: '1px solid #d9d9d9', borderRadius: '2px' },
                                                value: backtestEndTime,
                                                onChange: (e) => setBacktestEndTime(e.target.value),
                                                title: 'å›æµ‹æˆªè‡³æ—¶é—´ï¼Œé»˜è®¤ä¸ºå½“å‰æ—¶é—´'
                                            }),
                                            h(Button, {
                                                size: 'small',
                                                onClick: () => {
                                                    const now = new Date();
                                                    const year = now.getFullYear();
                                                    const month = String(now.getMonth() + 1).padStart(2, '0');
                                                    const day = String(now.getDate()).padStart(2, '0');
                                                    const hours = String(now.getHours()).padStart(2, '0');
                                                    const minutes = String(now.getMinutes()).padStart(2, '0');
                                                    setBacktestEndTime(`${year}-${month}-${day}T${hours}:${minutes}`);
                                                }
                                            }, 'å½“å‰')
                                        ),
                                        // å›æµ‹å¤©æ•°è¾“å…¥æ§ä»¶ï¼ˆ1~300ï¼Œé»˜è®¤2ï¼‰
                                        h('div', { style: { display: 'inline-flex', alignItems: 'center', gap: 8, marginRight: 12 } },
                                            h('span', { style: { fontSize: '12px', color: '#666' } }, 'å¤©æ•°'),
                                            h(InputNumber, {
                                                min: 1, max: 300, size: 'small', value: backtestDays,
                                                onChange: (v) => {
                                                    const nv = Number(v) || 2;
                                                    if (nv < 1 || nv > 300) return;
                                                    setBacktestDays(nv);
                                                },
            								style: { width: 80 }
                                            })
                                        ),
                                        // ç­–ç•¥ç‰ˆæœ¬é€‰æ‹©å™¨
                                        h('div', { style: { display: 'inline-flex', alignItems: 'center', gap: 8, marginRight: 12 } },
                                            h('span', { style: { fontSize: '12px', color: '#666' } }, 'ç­–ç•¥'),
                                            h(Select, {
                                                size: 'small',
                                                value: backtestStrategy,
                                                onChange: (value) => setBacktestStrategy(value),
                                                style: { width: 200 }
                                            }, 
                                                availableStrategies.map(strategy => 
                                                    h(Option, { 
                                                        key: strategy.version, 
                                                        value: strategy.version
                                                    }, strategy.version)
                                                )
                                            )
                                        )
                                    ),
                                    // ç¬¬äºŒè¡Œï¼šæŒ‡æ ‡é€‰æ‹©å™¨
                                    h('div', { className: 'indicator-controls' },
                                    h('label', null,
                                        h('input', { type: 'checkbox', defaultChecked: true, onChange: () => {
                                            if (!backtest.data) return; const cbs = document.querySelectorAll('input[data-indicator-bt]'); const sel = Array.from(cbs).filter(cb => cb.checked).map(cb => cb.dataset.indicatorBt); window.initTechnicalChart && window.initTechnicalChart(backtest.data.chart, sel, 'backtestTechnicalChart');
                                        }, 'data-indicator-bt': 'price' }), 'ä»·æ ¼æ›²çº¿'
                                    ),
                                    h('label', null,
                                        h('input', { type: 'checkbox', onChange: () => { if (!backtest.data) return; const cbs = document.querySelectorAll('input[data-indicator-bt]'); const sel = Array.from(cbs).filter(cb => cb.checked).map(cb => cb.dataset.indicatorBt); window.initTechnicalChart && window.initTechnicalChart(backtest.data.chart, sel, 'backtestTechnicalChart'); }, 'data-indicator-bt': 'sma5' }), 'SMA5'
                                    ),
                                    h('label', null,
                                        h('input', { type: 'checkbox', onChange: () => { if (!backtest.data) return; const cbs = document.querySelectorAll('input[data-indicator-bt]'); const sel = Array.from(cbs).filter(cb => cb.checked).map(cb => cb.dataset.indicatorBt); window.initTechnicalChart && window.initTechnicalChart(backtest.data.chart, sel, 'backtestTechnicalChart'); }, 'data-indicator-bt': 'sma20' }), 'SMA20'
                                    ),
                                    h('label', null,
                                        h('input', { type: 'checkbox', onChange: () => { if (!backtest.data) return; const cbs = document.querySelectorAll('input[data-indicator-bt]'); const sel = Array.from(cbs).filter(cb => cb.checked).map(cb => cb.dataset.indicatorBt); window.initTechnicalChart && window.initTechnicalChart(backtest.data.chart, sel, 'backtestTechnicalChart'); }, 'data-indicator-bt': 'sma50' }), 'SMA50'
                                    ),
                                    h('label', null,
                                        h('input', { type: 'checkbox', defaultChecked: true, onChange: () => { if (!backtest.data) return; const cbs = document.querySelectorAll('input[data-indicator-bt]'); const sel = Array.from(cbs).filter(cb => cb.checked).map(cb => cb.dataset.indicatorBt); window.initTechnicalChart && window.initTechnicalChart(backtest.data.chart, sel, 'backtestTechnicalChart'); }, 'data-indicator-bt': 'bollinger' }), 'å¸ƒæ—å¸¦é€šé“'
                                    ),
                                    h('label', null,
                                        h('input', { type: 'checkbox', onChange: () => { if (!backtest.data) return; const cbs = document.querySelectorAll('input[data-indicator-bt]'); const sel = Array.from(cbs).filter(cb => cb.checked).map(cb => cb.dataset.indicatorBt); window.initTechnicalChart && window.initTechnicalChart(backtest.data.chart, sel, 'backtestTechnicalChart'); }, 'data-indicator-bt': 'macd' }), 'MACDçº¿'
                                    ),
                                    h('label', null,
                                        h('input', { type: 'checkbox', defaultChecked: true, onChange: () => { if (!backtest.data) return; const cbs = document.querySelectorAll('input[data-indicator-bt]'); const sel = Array.from(cbs).filter(cb => cb.checked).map(cb => cb.dataset.indicatorBt); window.initTechnicalChart && window.initTechnicalChart(backtest.data.chart, sel, 'backtestTechnicalChart'); }, 'data-indicator-bt': 'macd_signal' }), 'MACDä¿¡å·çº¿'
                                    ),
                                    h('label', null,
                                        h('input', { type: 'checkbox', defaultChecked: true, onChange: () => { if (!backtest.data) return; const cbs = document.querySelectorAll('input[data-indicator-bt]'); const sel = Array.from(cbs).filter(cb => cb.checked).map(cb => cb.dataset.indicatorBt); window.initTechnicalChart && window.initTechnicalChart(backtest.data.chart, sel, 'backtestTechnicalChart'); }, 'data-indicator-bt': 'macd_histogram' }), 'MACDæŸ±çŠ¶å›¾'
                                    ),
                                    h('label', null,
                                        h('input', { type: 'checkbox', onChange: () => { if (!backtest.data) return; const cbs = document.querySelectorAll('input[data-indicator-bt]'); const sel = Array.from(cbs).filter(cb => cb.checked).map(cb => cb.dataset.indicatorBt); window.initTechnicalChart && window.initTechnicalChart(backtest.data.chart, sel, 'backtestTechnicalChart'); }, 'data-indicator-bt': 'rsi' }), 'RSI'
                                    ),
                                    h('label', null,
                                        h('input', { type: 'checkbox', onChange: () => { if (!backtest.data) return; const cbs = document.querySelectorAll('input[data-indicator-bt]'); const sel = Array.from(cbs).filter(cb => cb.checked).map(cb => cb.dataset.indicatorBt); window.initTechnicalChart && window.initTechnicalChart(backtest.data.chart, sel, 'backtestTechnicalChart'); }, 'data-indicator-bt': 'scores' }), 'Scoreè¯„åˆ†'
                                    ),
                                    h('label', null,
                                        h('input', { type: 'checkbox', defaultChecked: true, onChange: () => { if (!backtest.data) return; const cbs = document.querySelectorAll('input[data-indicator-bt]'); const sel = Array.from(cbs).filter(cb => cb.checked).map(cb => cb.dataset.indicatorBt); window.initTechnicalChart && window.initTechnicalChart(backtest.data.chart, sel, 'backtestTechnicalChart'); }, 'data-indicator-bt': 'decisions' }), 'äº¤æ˜“å†³ç­–'
                                    )
                                    )
                                ),
                                // å›¾è¡¨å’Œå¤©æ”¶ç›Šåˆ—è¡¨åŒºåŸŸ - åˆ†ä¸ºä¸¤åˆ—
                                h(Row, { gutter: 16 },
                                    // å·¦ä¾§ï¼šå›¾è¡¨åŒºåŸŸ
                                    h(Col, { xs: 24, lg: 18 },
                                        h('div', { id: 'backtestTechnicalChart-scroll', style: { height: '420px', padding: '10px', overflowX: 'auto' } },
                                            h('div', { id: 'backtestTechnicalChart-inner', style: { minWidth: '100%', height: '100%' } },
                                                h('canvas', { id: 'backtestTechnicalChart', style: { height: '100%', width: '100%' } })
                                            )
                                        )
                                    ),
                                    // å³ä¾§ï¼šå¤©æ”¶ç›Šåˆ—è¡¨
                                    h(Col, { xs: 24, lg: 6 },
                                        backtest.data ? (() => {
                                            // ä½¿ç”¨åç«¯è¿”å›çš„å®Œæ•´å¤©æ”¶ç›Šæ•°æ®ï¼ˆä¸å—20å¤©é™åˆ¶ï¼‰
                                            const dailyPnl = backtest.data.daily_pnl || [];
                                            const pageSize = 10;
                                            const totalPages = Math.ceil(dailyPnl.length / pageSize);
                                            const startIdx = (dailyPnlPage - 1) * pageSize;
                                            const endIdx = startIdx + pageSize;
                                            const currentData = dailyPnl.slice(startIdx, endIdx);
                                            
                                            return h('div', { style: { height: '420px', display: 'flex', flexDirection: 'column' } },
                                                h('h4', { style: { margin: '0 0 12px 0', fontSize: '14px', fontWeight: 'bold' } }, 'å¤©æ”¶ç›Šåˆ—è¡¨'),
                                                h('div', { style: { flex: 1, overflowY: 'auto', border: '1px solid #d9d9d9', borderRadius: '4px' } },
                                                    h('table', { style: { width: '100%', fontSize: '12px', borderCollapse: 'collapse' } },
                                                        h('thead', null,
                                                            h('tr', { style: { background: '#fafafa', borderBottom: '1px solid #d9d9d9' } },
                                                                h('th', { style: { padding: '8px', textAlign: 'left', fontWeight: 'bold' } }, 'æ—¥æœŸ'),
                                                                h('th', { style: { padding: '8px', textAlign: 'right', fontWeight: 'bold' } }, 'æ”¶ç›Š(USDT)')
                                                            )
                                                        ),
                                                        h('tbody', null,
                                                            currentData.length > 0 ? currentData.map((item, idx) =>
                                                                h('tr', { 
                                                                    key: item.date,
                                                                    style: { borderBottom: '1px solid #f0f0f0' }
                                                                },
                                                                    h('td', { style: { padding: '8px' } }, item.date),
                                                                    h('td', { 
                                                                        style: { 
                                                                            padding: '8px', 
                                                                            textAlign: 'right',
                                                                            color: item.pnl >= 0 ? '#f5222d' : '#52c41a',
                                                                            fontWeight: 'bold'
                                                                        } 
                                                                    }, `${item.pnl >= 0 ? '+' : ''}${item.pnl}`)
                                                                )
                                                            ) : h('tr', null,
                                                                h('td', { colSpan: 2, style: { padding: '20px', textAlign: 'center', color: '#999' } }, 'æš‚æ— æ•°æ®')
                                                            )
                                                        )
                                                    )
                                                ),
                                                totalPages > 1 ? h('div', { style: { marginTop: '8px', textAlign: 'center' } },
                                                    h(antd.Pagination, {
                                                        simple: true,
                                                        size: 'small',
                                                        current: dailyPnlPage,
                                                        total: dailyPnl.length,
                                                        pageSize: pageSize,
                                                        onChange: (page) => setDailyPnlPage(page)
                                                    })
                                                ) : null
                                            );
                                        })() : h('div', { style: { height: '420px', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#999', fontSize: '14px' } }, 'è¿è¡Œå›æµ‹åæ˜¾ç¤ºå¤©æ”¶ç›Š')
                                    )
                                ),
                                backtest.data ? h('div', { style: { padding: '8px 12px', background: '#fafafa', borderRadius: 8, marginTop: 8, fontSize: '12px', lineHeight: '20px' } },
                                    h(Space, { size: 'middle', wrap: true },
                                        h('span', null, `æ•°æ®ç‚¹: ${backtest.data.summary.data_points}`),
                                        h('span', null, `ä¿¡å·æ•°: ${backtest.data.summary.total_signals}`),
                                        h('span', null, `å·²å¹³ä»“: ${backtest.data.summary.closed_trades}`),
                                        h('span', { style: { color: backtest.data.summary.net_pnl_total >= 0 ? '#f5222d' : '#52c41a', fontWeight: 'bold' } }, `å‡€æ”¶ç›Š: ${backtest.data.summary.net_pnl_total} USDT`),
                                        h('span', { style: { color: backtest.data.summary.gross_pnl_total >= 0 ? '#f5222d' : '#52c41a' } }, `æ¯›æ”¶ç›Š: ${backtest.data.summary.gross_pnl_total} USDT`),
                                        h('span', { style: { color: '#fa8c16' } }, `æ‰‹ç»­è´¹: ${backtest.data.summary.total_fees} USDT`),
                                        h('span', null, `èƒœç‡: ${backtest.data.summary.win_rate}%`),
                                        h('span', null, `å‡(æ¯›): ${backtest.data.summary.avg_pnl_gross} USDT`),
                                        h('span', null, `å‡(å‡€): ${backtest.data.summary.avg_pnl_net} USDT`)
                                    )
                                ) : null
                            )
                        )
                    ),

                    // å›¾è¡¨å’Œç»©æ•ˆè¡Œ
                    h(Row, { gutter: [16, 16], style: { marginBottom: 16 } },
                        h(Col, { xs: 24, lg: 16 },
                            h(Card, { title: 'ä»·æ ¼èµ°åŠ¿ & äº¤æ˜“ä¿¡å·', style: { height: 400 } },
                                h('div', { style: { height: '320px', padding: '10px' } },
                                    h('canvas', { id: 'priceChart' })
                                )
                            )
                        ),
                        h(Col, { xs: 24, lg: 8 },
                            h(Card, { title: 'äº¤æ˜“ç»©æ•ˆ', style: { height: 400 } },
                                // ç»Ÿè®¡æŒ‡æ ‡è¡Œ
                                h(Row, { gutter: [8, 8], style: { marginBottom: 16 } },
                                    ...perfStats.map((v, i) => 
                                        h(Col, { xs: 12, key: i },
                                            h(Card, { bordered: true, size: 'small' },
                                                h(Statistic, { 
                                                    title: v[1], 
                                                    value: v[0], 
                                                    prefix: v[2], 
                                                    suffix: v[1].includes('ç›ˆäº') ? 'USDT' : '', 
                                                    valueStyle: { color: v[3], fontSize: '18px' } 
                                                })
                                            )
                                        )
                                    )
                                ),
                                // æ¯æ—¥ç›ˆäºå›¾è¡¨
                                h('div', { style: { padding: 12, background: '#fafafa', borderRadius: 8, height: '120px' } },
                                    h(Text, { strong: true, style: { display: 'block', marginBottom: 8 } }, 'æ¯æ—¥ç›ˆäº'),
                                    h('div', { style: { height: '70px' } },
                                        h('canvas', { id: 'dailyPnlChart' })
                                    )
                                )
                            )
                        )
                    ),

                    h(Row, { gutter: [16, 16] },
                        h(Col, { xs: 24, lg: 12 },
                            h(Card, { title: 'æœ€è¿‘äº¤æ˜“è®°å½•', style: { height: 450 } },
                                h(Table, {
                                    dataSource: trades.slice(-10).reverse().map((item, i) => ({ ...item, key: item.id || i })),
                                    columns: tradeColumns, ...tableProps,
                                    locale: { emptyText: 'æš‚æ— äº¤æ˜“è®°å½•' }, scroll: { y: 300 }
                                })
                            )
                        ),
                        h(Col, { xs: 24, lg: 12 },
                            h(Card, { title: 'AIåˆ†æè¯¦æƒ…', style: { height: 450 } },
                                h(Tabs, { 
                                    defaultActiveKey: '1', 
                                    size: 'small',
                                    items: [
                                        {
                                            key: '1',
                                            label: 'å½“å‰åˆ†æ',
                                            children: h(Space, { direction: 'vertical', style: { width: '100%' }, size: 'middle' },
                                                h('div', null,
                                                    h(Text, { strong: true }, 'å†³ç­–ç†ç”±'),
                                                    h('div', { style: { marginTop: 8, padding: 16, background: '#f5f5f5', borderRadius: 8, fontSize: '14px', lineHeight: '1.6', maxHeight: '120px', overflowY: 'auto' } },
                                                        aiSignal.reason || 'ç³»ç»Ÿæ­£åœ¨åˆ†æå¸‚åœºæ•°æ®ï¼Œè¯·ç¨å€™...'
                                                    )
                                                ),
                                                h(Row, { gutter: 16 },
                                                    ...['æ­¢æŸä»·æ ¼', 'æ­¢ç›ˆä»·æ ¼'].map((label, i) => 
                                                        h(Col, { span: 12 },
                                                            h(Text, { strong: true }, label),
                                                            h('div', { style: { fontSize: '20px', fontWeight: 'bold', color: i ? '#52c41a' : '#f5222d', marginTop: 8 } },
                                                                (i ? aiSignal.take_profit : aiSignal.stop_loss) ? `$${(i ? aiSignal.take_profit : aiSignal.stop_loss).toLocaleString()}` : '--'
                                                            )
                                                        )
                                                    )
                                                ),
                                                h('div', null,
                                                    h(Text, { strong: true }, 'æŠ€æœ¯æŒ‡æ ‡')
                                                )
                                            )
                                        },
                                        {
                                            key: '2',
                                            label: 'å†å²è®°å½•',
                                            children: h('div', { style: { height: '100%' } },
                                                h(Table, {
                                                    dataSource: analysisData.data?.map((item, i) => ({ ...item, key: item.id || i })) || [],
                                                    expandable: {
                                                        expandedRowRender: record => h('div', { style: { padding: '16px', background: '#fafafa', borderRadius: '4px', fontSize: '13px', lineHeight: '1.5' } }, record.reason || 'æš‚æ— è¯¦ç»†ä¿¡æ¯'),
                                                        rowExpandable: record => !!(record.reason)
                                                    },
                                                    columns: analysisColumns, 
                                                    rowKey: 'key', 
                                                    size: 'small', 
                                                    pagination: false,
                                                    locale: { emptyText: 'æš‚æ— åˆ†æè®°å½•' }, 
                                                    scroll: { y: 200 }
                                                }),
                                                // åˆ†é¡µç»„ä»¶
                                                analysisData.pagination?.total_count > 0 && h('div', { style: { textAlign: 'center', marginTop: '16px', paddingTop: '8px', borderTop: '1px solid #f0f0f0' } },
                                                    h(Pagination, {
                                                        current: analysisData.pagination.page,
                                                        pageSize: analysisData.pagination.page_size,
                                                        total: analysisData.pagination.total_count,
                                                        showSizeChanger: true,
                                                        showQuickJumper: true,
                                                        showTotal: (total, range) => `ç¬¬ ${range[0]}-${range[1]} æ¡ï¼Œå…± ${total} æ¡`,
                                                        pageSizeOptions: ['5', '10', '20', '50'],
                                                        size: 'small',
                                                        onChange: (page, pageSize) => {
                                                            setAnalysisPage(page);
                                                            loadAnalysisData(page, pageSize);
                                                        },
                                                        onShowSizeChange: (current, size) => {
                                                            setAnalysisPage(1);
                                                            loadAnalysisData(1, size);
                                                        }
                                                    })
                                                )
                                            )
                                        }
                                    ]
                                })
                            )
                        )
                    )
                )
            );
        }

        ReactDOM.render(h(App), document.getElementById('root'));
    </script>
</body>
</html>